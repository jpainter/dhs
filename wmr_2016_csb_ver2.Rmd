---
title: "wmr_2016_csb"
author: "jp"
date: "10/25/2016"
output: word_document
---

```{r setup, include=FALSE, cache=FALSE}
library(knitr)
knitr::opts_chunk$set(echo = FALSE, cache = TRUE)
```

```{r, include = FALSE, cache=FALSE}
library(data.table)
library(tidyverse)
library(lubridate)
library(scales)
library(survey)
library(gridExtra)
library(countrycode)
library(readr)
library(readxl)

library(survey)  
options(survey.lonely.psu="adjust")
options(survey.adjust.domain.lonely=TRUE)
```

# Main data 


```{r,  include = FALSE}

source("file_list.r")

subsahara = countrycode_data %>%
  filter( region %in% c("Middle Africa", "Western Africa", "Eastern Africa", "Southern Africa")) %>% 
  select( country.name, iso3c ) %>%
  filter( !country.name %in% "Lesotho") 


files = files %>% 
  mutate( country.name = countrycode(country, "country.name", "country.name")) %>%
  filter( survey!="", year >= 2006 , country.name %in% subsahara$country.name)

# not_needed = c('Bangladesh', 'Pakistan', 'Philippines', 'Comoros')

survey_list = files %>% count(country, survey, year) %>% select(-n) %>% arrange(desc(year))

nsurveys = nrow(survey_list)
ncountries = length( unique( files$country ) )

kable(survey_list, row.names = TRUE)

```

```{r, include = FALSE, eval= FALSE}
# select variables for this analysis, v
variables =  c('v000', 
       'v001', 'v002', 'v003', 'v005', 'v021', 'v023', 'v024', 'v025', 
       'weight.c', 'weight.hm', 'weight.w', 'weight.h', 
       'hv001',  'hv002', 'hv003',  'hv005', 'hv007', 'hv021', 'hv022', 'hv023', 'hv024', 'hv025',
       'hvidx', 'b16',
       'h22', 'hv105', 'h47', 
       'hml16', # age in years
       'hml32', 'hml35',
       
       # providers
      'h32a', 'h32b', 'h32c', 'h32d', 'h32e', 'h32f', 'h32g', 'h32h', 'h32i', 'h32s', #public/govt
      'h32j', 'h32k', 'h32l', 'h32m', 'h32n', 'h32o', 'h32p', 'h32q', 'h32r', #private
      'h32t', 'h32u', 'h32v', 'h32w', 'h32x', # informal privage/other
      'h32y', # no medical rx
      'h32z' # medical rx.  what's that mean?
      
      )

```

```{r, include = FALSE, eval= FALSE}
source("dhs_load_survey.R")

nsurveys = nrow(survey_list)

survey_list = survey_list %>% arrange( desc(year) )
index = row.names(survey_list)

p <- progress_estimated(nsurveys)

x <- vector("list", length( nsurveys)) 

translate = FALSE  # optional translation of values to label.  
  # NB: Does not work well for all variables

for (i in seq_along( index ) ){
  
   p$pause(0.1)$tick()$print()
  
  .country = survey_list[i, ]$country
  .iso3c = countrycode( survey_list[i, ]$country, "country.name", "iso3c")
  .survey = survey_list[i, ]$survey
  .year = survey_list[i, ]$year
  .survey_year = paste(.survey, .year)

  print( paste(.country, .survey, .year))
  
  svy <- try( silent = TRUE,
    load_survey_object( design = FALSE,
                        # printout = TRUE ,  # un comment when testing
                        vars = variables, 
                        .country = .country, 
                        .survey = .survey,
                        .year = .year)
  )
  
  #TODO FILTER RECORDS--apply filter, like keeping only children with parasitemia, is not unnecessarily large

  if ( class(svy) == "try-error" ){ 
    next()
    }

  # returns: svy.h, svy.c, svy.w, svy.hm, vars_x, x
  # svy.h <- svy[[1]]
  # svy.c <- svy[[2]]
  # svy.w <- svy[[3]]
  # svy.hm <- svy[[4]]
  has_vars = svy[[5]]
  x[[i]] = svy[[6]] 
  
  x[[i]]$country = rep( .country, nrow(x[[i]]) )
  x[[i]]$iso3c = rep( .iso3c, nrow(x[[i]]) )
  x[[i]]$year = rep( .year, nrow(x[[i]]) )
  x[[i]]$survey = rep( .survey, nrow(x[[i]]) )

  # TODO: optional- relate dictionary to survey                    )

  # # TODO: only for columns with >4 values (others easier to keep as numeric)
  # # Deriving this table should happen once, before loop
  # v = dd %>% filter( tolower(Item_Name) %in% variables) %>% group_by( Item_Name, label ) %>% 
  #   summarise( n = n()) %>% group_by( Item_Name) %>% count(Item_Name) %>% filter(nn>4) 

  if (translate){
    
      # refine dictionary for this country-survey 
      dict = dd %>% filter_( ~country == .country , ~survey == .survey, ~year == .year,
                        ~Item_Name %in% toupper(names(has_vars))
      )
     
    y = x[[i]]
  
    for (col in 1:length(colnames(y))){
      column = tolower( colnames(y)[col] )
      
      dict_var = dict %>% 
        mutate( item_name = tolower(Item_Name)) %>%
        filter_( ~item_name == column ) %>% # , ~file == "Household Member Recode"
        count( value, label) %>% select(-n)
      
      old_value = y[, col]
      new_value = dict_var[ match( old_value, dict_var$value ), ]$label
      y[, col] = ifelse( is.na( new_value), old_value, new_value)
    }
      x[[i]] = y
}

  # if (is.null(X) ){ X <- x; next()}
  # X = rbindlist( list(X, x), use.names = TRUE, fill = TRUE)
  
}
  
# X = dplyr:: bind_rows( x )  # will throw error is column types dont match 
X = rbindlist(x, fill = TRUE) %>% rownames_to_column("id")

saveRDS(X, "csb.rds")

# object.size(X)

```

```{r, include = FALSE}
x = readRDS("csb.rds")
```

## subset to available surveys in Sub-saharan Africa from 2010 to 2016: 

```{r}

subsahara = countrycode_data %>%
  filter( region %in% c("Middle Africa", "Western Africa", "Eastern Africa", "Southern Africa")) %>% 
  select( country.name, iso3c ) %>%
  filter( !country.name %in% "Lesotho") 

x = x %>% 
  mutate( startyear = as.integer( substr( year, 1, 4 ) ),
            endyear = as.integer(
              ifelse( nchar(year)>4, 
                              paste0("20", substr( year, 6, 7 )), 
                              substr( year, 1, 4 ))
            )
            ) %>%
  filter( endyear >= 2010, 
          iso3c %in% subsahara$iso3c ) %>% 
  as.data.table()

x.list = x %>% count( country, survey, year ) %>% arrange(desc(year) )

kable( x.list %>% select(-n) , row.names = TRUE)


```

## lookup provider (h32) values and translate to care level 

```{r}

# originally used 2014 file to map dhs values to one of 16 WMR defined provider types
# csb_mapped_2014 <- read.csv("~/Dropbox/_Malaria/Projects/WMR/csb_final_mapped_17Oct2014.csv",
#                             locale = locale(encoding = "WINDOWS-1252"))

# then added values from later surveys...so now open _2016 file
# csb_mapped_2016 <- read.csv("~/Dropbox/_Malaria/Projects/WMR/csb_mapped_2016.csv",
#                             locale = locale(encoding = "WINDOWS-1252"))

csb_translatation_file = "csb_mapped_october27_2016.csv"

csb_mapped<- read.csv(  csb_translatation_file, stringsAsFactors = FALSE )

# write_excel_csv( csb_mapped, csb_translatation_file) 




csb_levels_file = "csb_levels_october27_2016.csv"

csb_levels = read.csv(  csb_levels_file, stringsAsFactors = FALSE  )

  

# write_excel_csv( csb_levels, csb_levels_file) 

 # kable( xp %>% count( country, survey, year ) %>% arrange(desc(year) ) , row.names = TRUE)

```

```{r}
cat( "The file used to translate h32a-h32z to care_level is", csb_translatation_file, "\n" )

cat( "The file that translates the care_levels into smaller categories is", csb_levels_file, "\n")

```


## data dictionary

```{r, warning=FALSE}
# # get dictionary vales from children's file 
# 
  dd <-readRDS("dictionaryNew.rds")  # about 6 sec

  ddc = dd %>% ungroup %>%
    filter( grepl( "Children", file ) | grepl( "kr", file )
            ) %>%
    mutate(
      startyear = as.integer( substr( year, 1, 4 ) ) ,
      Item_Label = tolower( Item_Label ) ,
      Item_Name = tolower( Item_Name)
    ) %>%
    count( country, survey, startyear, Item_Name, Item_Label) %>% ungroup()

#   kable( ddc %>% count( country, survey, startyear ) %>% arrange(desc(startyear) ) , row.names = TRUE)

```

# transform dataset

```{r}
## transform dataset to long format by provider 

# selet needed columns from dataset
xp = x %>%
    select( country, iso3c, startyear, year, survey, hv021, hv023, weight.c, 
            starts_with("h32"), h47) %>%
    mutate( id = row_number() )  %>%
    ungroup

  xl = xp %>% 
    gather(provider, value, -country, -iso3c, -startyear, -year, -survey, 
           -hv021, -hv023, -weight.c, -h47, -id)  %>%
    mutate( provider = tolower(provider),
            value = as.character(value)) %>%
    filter( !(provider %in% 'h32z') ) %>%  # remove all the 'no provider' 
    filter( !is.na(value)) # remove unused providers

  # join with dictionary file to get labels for each variable
  xld = xl %>%
    left_join(ddc, by = c('country' = 'country', 'survey' = 'survey', 'startyear' = 'startyear',
                           'provider' = 'Item_Name' ) ) %>%
    select(-n)

  # xld = xl # bypass dictionary step and lookup on variable name instead of label
 
  # lookup care_levels for each  provider
  
  csb_map = csb_mapped %>% 
    group_by( iso3, startyear, varname ) %>%
    summarise( care_level = first(care_level))
  
  # View( count(csb_map, iso3, startyear,care_level) %>% spread( care_level, n) )
  
  xld$care_level = as.integer( csb_map[ match( 
    paste(xld$iso3c, xld$startyear, xld$provider), 
    paste(csb_map$iso3, csb_map$startyear, csb_map$varname) 
    ),]$care_level )
  


  
  ## transform back to wide format with provider 
  
  x.provider.l = xld %>% 
    mutate( startyear = as.integer( substr( year, 1, 4 ) ),
            endyear = as.integer(
                        ifelse( nchar(year)>4, 
                              paste0("20", substr( year, 6, 7 )), 
                              substr( year, 1, 4 ) )
                        ),
              value = as.integer( ifelse( value %in% "9", NA, value ) )  # replace 9 with NA, convert to int
    ) %>%
    group_by( iso3c, survey, startyear, endyear, id, hv021,  hv023, weight.c, h47, care_level) %>%
    summarise( value = max( value, na.rm = TRUE ) ) %>% ungroup() %>%
    filter( !is.na( care_level )) 

### define grouping levels  
x.provider.l$care_level6 = csb_levels[ match(x.provider.l$care_level, csb_levels$care_level), "care_level_6"]
x.provider.l$care_level5 = csb_levels[ match(x.provider.l$care_level, csb_levels$care_level), "care_level_5"]
x.provider.l$care_level4 = csb_levels[ match(x.provider.l$care_level, csb_levels$care_level), "care_level_4"]
x.provider.l$care_level3 = csb_levels[ match(x.provider.l$care_level, csb_levels$care_level), "care_level_3"]
x.provider.l$care_level3b = csb_levels[ match(x.provider.l$care_level, csb_levels$care_level), "care_level_3b"]
    
# x.provider.w = x.provider.l %>% spread( care_level, value) 
  
# NB: because the h32z variable, 'medical treatment', is coded in survey as summary when any 
# of the the providers are chosen, we don't want to count it as a type of provider.  It just means 
# a provider was selected.  But the csb file maps these to 'other', which result in double counting.
# So--the column h32z is now removed in an earlier step ( see creation of xl dataset, above).  
# Note that h32y, 'no treatment' is still included.  

```

## save dataset to excel
```{r}

write_excel_csv(x.provider.l, "~/Dropbox/_Malaria/Projects/WMR/csb_survey_long_wmr2016.csv")

```

### Data checks-- find rows with missing care_level--and updateing csb excel files
```{r, eval=FALSE}
    
  
    # look at un-joined....
  xxx = xld %>% filter( is.na(care_level)) %>% count( country, survey, year)
  
  # remove rows with mising labels
  xld. = xld %>% filter( !is.na(provider))

  table(  xld.$care_level, useNA = 'always')

  xld.m = xld. %>%
    filter( is.na( care_level)) %>%
    rename( iso3 = iso3c,
            varname = provider,
            varlab = Item_Label,
            filename = survey) %>%
    mutate( startyear = as.integer( substr( year, 1, 4 ) ),
            endyear = as.integer(
              ifelse( nchar(year)>4,
                              paste0("20", substr( year, 6, 7 )),
                              substr( year, 1, 4 ))
            )
            ) %>%
  count( iso3, startyear, endyear, filename, varname, varlab)

  # View( xld.m )
  
  # Add the missing labels back to the csb_mapped file (then comment out lines so not re-run) #
    # 1.
    # add_csb_mapped = xld.m %>%  ungroup %>%
    #   select(iso3, startyear, endyear, filename, varname, varlab)
    # 
    # csb_mapped_new = bind_rows( csb_mapped, add_csb_mapped)
    # write_excel_csv(csb_mapped_new, "~/Dropbox/_Malaria/Projects/WMR/csb_mapped_2016_27oct.csv")

    # 2. go to excel/csv file and classify the care_levels to be consistent with previous categorizations
    # 3. re-make a csb_mapped.csv file, point to it in line 221, and re-run
    
```


### (run once after loading new data) 
```{r, eval=FALSE}

# how many kids sought care at more than one type of provider
care_cols = c("CHW", "Public", "Formal Private", "Informal Private") 

x.provider.5 = x.provider.l %>%  
  group_by( iso3c, survey, startyear, endyear, id, hv021, hv023, weight.c, h47, care_level5) %>%
  summarise( value = max( value, na.rm = TRUE ) ) %>% ungroup() %>%
  spread( care_level5, value)   # return to one record per person

x.provider.5 = data.table(x.provider.5)
x.provider.5 = x.provider.5[ , nprovider := rowSums( .SD , na.rm = TRUE), .SDcols = care_cols]                           

count(x.provider.5, nprovider)  # only 444 /(8281+14425+436+8), 1.9%, had>1 provider type

z = xl %>% group_by(id) %>%
  summarise( sz = sum( ifelse( provider %in% 'h32z', as.integer(value), 0 ) ) ,
             sy = sum( ifelse( provider %in% 'h32y', as.integer(value), 0 ) ) ,
             so = sum( ifelse( provider %in% c('h32z','h32y'), 0, as.integer(value) ), na.rm = TRUE )
             )

sum( z$sy == 1 & z$so>0 )  # is there ever a provider selected (so>0) and 'no provider'?  0

sum( z$so == 0 & z$sz>0 , na.rm=TRUE) # is there ever any provider selected (sz>0) and no specific provider (so==0)?  0

sum( z$so>0 & z$sz>0 , na.rm=TRUE) ; sum( z$so>0); sum( z$sz>0, na.rm = TRUE)
```


# Estimates  
## Providers for care seeking (endyear >= 2014)
## 6 levels 
```{r, include=FALSE}

options(survey.lonely.psu="adjust")
options(survey.adjust.domain.lonely=TRUE)

  x.provider.6 = x.provider.l %>%  
    filter( endyear >= 2014 ) %>% 
    group_by( iso3c, survey, startyear, endyear, id, hv021, hv023, weight.c, h47, care_level6) %>%
    summarise( value = max( value, na.rm = TRUE ) ) %>% ungroup() %>%
    spread( care_level6, value)   # return to one record per person

   data = x.provider.6
   care_cols = c( "Public", "CHW", "Charity" , "Formal Private", "Informal Private", "No Treatment") 

  estimates_all_6 = NULL
  
  for ( .var in care_cols ){
    estimates = list()
    
  for ( i in seq_along( rownames(x.list)  )){
  
    .country = x.list$country[i]
    .iso3c = countrycode( .country, "country.name", "iso3c")
    .survey = x.list$survey[i]
    .year = x.list$year[i]
    .startyear = as.integer( substr( x.list$year[i], 1, 4) )
    .endyear = as.integer(
                          ifelse( nchar(x.list$year[i])>4, 
                                paste0("20", substr( x.list$year[i], 6, 7 )), 
                                substr( x.list$year[i], 1, 4 ) )
                          )
    .survey_year =  paste(.survey, .year)
  
    cat( .country, .survey, .year, "\n") 
    
    xx = data %>% 
      filter( iso3c %in% .iso3c ,
              survey %in% .survey , 
              startyear %in% .startyear ,
             !is.na(hv021)  # survey design object, below, requires non missing value for psu (hv021)
             )  %>%
      # select_( "iso3c", "startyear", "endyear", "survey", "hv021", "weight.c", .dots = care_cols_ ) %>%
      select_( "iso3c", "startyear", "endyear",   "survey", "hv021", "hv023", "weight.c",
               .dots = c("Public", "Charity", "CHW" , "`Formal Private`", "`Informal Private`", "`No Treatment`")  ) %>%
      ungroup
    
    # if no survey, or no values, move on
    if ( nrow(xx) == 0) next 
    if ( sum(is.na( xx[, .var])) == nrow(xx) ) next 
    
    
    # Survey design object 
      
    unique( with(xx, paste(iso3c, survey, startyear)) )
      
      # test if strata exists; some surveys have no strata (e.g. madagascar mis 2011)
      has.strata.023 = nrow( as.data.frame.table( table(xx$hv023) ) ) > 1
  
      if (has.strata.023) { # urban/rural
        strataformula.c = as.formula("~hv023 ")
      } else {
          strataformula.c = NULL
      }
      
      svy.x.c  <- 
                svydesign( 
                  ~hv021  , # psu 
                  strata = strataformula.c , 
                  data =  xx, 
                  weights = ~ weight.c
                )  
    
    # survey eSTIMATES   
    
      # convert svyciprop to df
      p = svyciprop( as.formula( paste0("~`",.var, "`") ), svy.x.c, method="lo")
      pp = cbind( as.numeric(p), as.data.frame( t(attributes(p)$ci) ) )
      names(pp)[1] = "Est."
      pp$var = names(p)
      cat( paste( pp, collapse = " ") , "\n")
      
      estimates[[i]] = bind_cols(  data_frame( country = .country,
                                               iso3 = .iso3c,
                                               startyear = .startyear,
                                               endyear = .endyear,
                                               survey = .survey
                                               ) ,
                                   pp
      )
    
    }
    
  estimates_var = rbindlist(estimates, fill = TRUE) %>% rownames_to_column("id")
  
  if ( is.null(estimates_all_6) ){
    estimates_all_6 = estimates_var
    } else {
      estimates_all_6 = bind_rows( estimates_var , estimates_all_6)
  }
  
  }
  
  # View(estimates_all_6)
  write_excel_csv(estimates_all_6, "~/Dropbox/_Malaria/Projects/WMR/csb_test_summary6_wmr2016.csv")
  
  est = estimates_all_6 %>% select(-`2.5%`, -`97.5%`) %>% spread(var, Est.)
  
  # write_excel_csv(est, "~/Dropbox/_Malaria/Projects/WMR/John3.9.6.csv")

  csb_6 = paste0("csb6_", substr(now(),1,10), ".csv")

  write_excel_csv( estimates_all_6, csb_6 )

```

```{r, include=FALSE }


estimates_all_6 = read.csv( csb_6 , stringsAsFactors = FALSE )

## Plot provider (3.9) 6 levels
  data = estimates_all_6 %>% filter( endyear>2013) %>% 
    rename( provider = var, percent = Est. ) %>%
    mutate( provider = factor( provider, 
                                     levels = c( "Public", "CHW", "Charity", "Formal Private", "Informal Private", "No Treatment") ,
                                     labels = c( "Public\nhealth\nfacility", 
                                                 "Community\nhealth\nworker",
                                                 "Non-profit\nhealth\ncare",
                                                 "Formal private\nhealth\ncare", 
                                                "Inormal private\nhealth\ncare",
                                                "Not seeking\ncare outside\nof home"))
                  )
  
  # count( data, country, startyear, endyear, survey)
  
  ylabel = "Proportion of febrile children\npresenting for treatment\n"
  
  fig.3.9.6 = ggplot( data , 
        aes( provider, percent)
        ) + 
  # guides(color = guide_legend()) +
  scale_y_continuous( ylabel , label = percent, limits = c(0, 1) )  +
  scale_x_discrete("") +
  stat_boxplot(geom ='errorbar', width = .1, size = .2) + 
  geom_boxplot( fill = 'light blue', size= .2, outlier.color = 'white', width = .5) +
  theme_bw() +
  theme( axis.text = element_text(size=8) ,
         axis.title = element_text(size=8, hjust = .5, face = 'plain'),
         title  = element_text(size=9, face = 'bold', hjust = 0)) +
  ggtitle( "Figure 3.9 Proportion of febrile children presenting for treatment, by health sector, sub-Saharan Africa, 2014-2015")
  
  fig.3.9.6
  
  # ggsave( "Figure 3.9.6categories.pdf")
```

```{r}
cat( "The file used for 6 care_levels is", csb_6, "\n" )

```

# Testing rates by provider for endyear >= 2014
## 6 levels  

```{r, include=FALSE }

options(survey.lonely.psu="adjust")
options(survey.adjust.domain.lonely=TRUE)

 x.provider.6 = x.provider.l %>% 
    filter( endyear >= 2014 ) %>% 
    group_by( iso3c, survey, startyear, endyear, id, hv021, hv023, weight.c, h47, care_level6) %>%
    summarise( value = max( value, na.rm = TRUE ) ) %>% ungroup() %>%
    spread( care_level6, value)   # return to one record per person

  data = x.provider.6 %>% mutate( h47 = ifelse(h47 %in% 8:9, NA, h47))
 
  care_cols = c( "Public", "CHW", "Charity", "Formal Private", "Informal Private", "No Treatment") 

  estimates_all_6_test = NULL
  
  for ( .var in care_cols ){
    estimates = list()
    
  for ( i in seq_along( rownames(x.list)  )){
  
    .country = x.list$country[i]
    .iso3c = countrycode( .country, "country.name", "iso3c")
    .survey = x.list$survey[i]
    .year = x.list$year[i]
    .startyear = as.integer( substr( x.list$year[i], 1, 4) )
    .endyear = as.integer(
                          ifelse( nchar(x.list$year[i])>4, 
                                paste0("20", substr( x.list$year[i], 6, 7 )), 
                                substr( x.list$year[i], 1, 4 ) )
                          )
    .survey_year =  paste(.survey, .year)
  
    cat( .country, .survey, .year, "\n") 
    
    xx = data %>% 
      filter( iso3c %in% .iso3c ,
              survey %in% .survey , 
              startyear %in% .startyear ,
             !is.na(hv021)  # survey design object, below, requires non missing value for psu (hv021)
             )  %>%
      # select_( "iso3c", "startyear", "endyear", "survey", "hv021", "weight.c", .dots = care_cols_ ) %>%
      select_( "iso3c", "startyear", "endyear",   "survey", "hv021", "hv023", "weight.c", "h47",
               .dots = c("Public", "CHW" , "Charity", "`Formal Private`", "`Informal Private`", "`No Treatment`")  ) %>%
      ungroup
    
    # if no survey, or no values, move on
    if ( nrow(xx) == 0) next 
    if ( sum(is.na( xx[, .var])) == nrow(xx) ) next 
    
    
    # Survey design object 
      
    cat( unique( with(xx, paste(iso3c, survey, startyear, .var)) ), "\n" )
      
      # test if strata exists; some surveys have no strata (e.g. madagascar mis 2011)
      has.strata.023 = nrow( as.data.frame.table( table(xx$hv023) ) ) > 1
  
      if (has.strata.023) { # urban/rural
        strataformula.c = as.formula("~hv023 ")
      } else {
          strataformula.c = NULL
      }
      
      svy.x.c  <- 
                svydesign( 
                  ~hv021  , # psu 
                  strata = strataformula.c , 
                  data =  xx, 
                  weights = ~ weight.c
                )  
    
    # survey eSTIMATES   

      if ( .var == "CHW") subset.design = subset(svy.x.c, CHW == 1 ) 
      if ( .var == "Charity") subset.design = subset(svy.x.c, Charity == 1 ) 
      if ( .var == "Public") subset.design = subset(svy.x.c, Public == 1 ) 
      if ( .var == "No Treatment") subset.design = subset(svy.x.c, `No Treatment` == 1 ) 
      if ( .var == "Formal Private") subset.design = subset(svy.x.c, `Formal Private` == 1 ) 
      if ( .var == "Informal Private") subset.design = subset(svy.x.c, `Informal Private` == 1 ) 
        
      # test is subset has values
      if ( nrow(subset.design) == 0 ) next 
      if ( sum(is.na( subset.design$variables$h47)) == nrow(subset.design) ) next 
    
     # convert svyciprop to df
      # p = svyciprop( as.formula( paste0("~`",.var, "`") ), svy.x.c, method="lo")
      p = svyciprop( ~h47, subset.design, method="lo")
      
      pp = cbind( as.numeric(p), as.data.frame( t(attributes(p)$ci) ) )
      names(pp)[1] = "Est."
      pp$var = names(p)
      cat( paste( pp, collapse = " ") , "\n")
      
      estimates[[i]] = bind_cols(  data_frame( country = .country,
                                               iso3 = .iso3c,
                                               startyear = .startyear,
                                               endyear = .endyear,
                                               survey = .survey,
                                               provider = .var
                                               ) ,
                                   pp
      )
    
    }
    
  estimates_var = rbindlist(estimates, fill = TRUE) %>% rownames_to_column("id")
  
  if ( is.null(estimates_all_6_test) ){
     estimates_all_6_test = estimates_var
    } else {
      estimates_all_6_test = bind_rows( estimates_var , estimates_all_6_test)
  }
  
  }
  
  # View(estimates_all_6)
  
  # write_excel_csv(estimates_all_6, "~/Dropbox/_Malaria/Projects/WMR/csb_test_summary6_wmr2016.csv")
  
  csb_6_test = paste0("csb6_test", substr(now(),1,10) , ".csv")

  write_excel_csv( estimates_all_6_test,  paste0("~/Dropbox/_Malaria/Projects/WMR/", csb_6_test ) )
  
  

```


```{r, include=FALSE }

 
  estimates_all_6_test = read.csv(csb_6_test, stringsAsFactors = FALSE )
  
  ## Plot test by 6 provider (3.10) 
  data = estimates_all_6_test %>% filter( endyear>2013) %>% 
    rename( percent = Est. ) %>%
    mutate( provider = factor( provider, 
                                     levels = c( "Public", "CHW", "Charity", "Formal Private", "Informal Private", "No Treatment") ,
                                     labels = c( "Public\nhealth\nfacility", 
                                                 "Community\nhealth\nworker",
                                                 "Non-profit\nhealth\ncare",
                                                 "Formal private\nhealth\ncare", 
                                                "Inormal private\nhealth\ncare",
                                                "Not seeking\ncare outside\nof home"))
                  )
  
  # count( data, country, startyear, endyear, survey)
  
  ylabel = "Proportion of febrile children\nreceiving a blood test"
  
  fig.3.10.6 = ggplot( data , 
        aes( provider, percent)
        ) + 
  # guides(color = guide_legend()) +
  scale_y_continuous( ylabel , label = percent, limits = c(0, 1) )  +
  scale_x_discrete("") +
  stat_boxplot(geom ='errorbar', width = .1, size = .2) + 
  geom_boxplot( fill = 'light blue', size= .2, outlier.color = 'white', width = .5) +
  theme_bw() +
  theme( axis.text = element_text(size=8) ,
         axis.title = element_text(size=8, hjust = .5, face = 'plain'),
         title  = element_text(size=9, face = 'bold', hjust = 0)) +
  ggtitle( "Figure 3.10 Proportion of febrile children tested for malaria, by health sector, sub-Saharan Africa, 2014-2015")
  
  fig.3.10.6
  
  # ggsave( "Figure 3.10.6categories.pdf")
  
```

```{r}
 cat( "The file used for testing rates among the 6 care_levels is", csb_6_test, "\n" )

```

# Combined provider and test rates 

```{r, fig.height= 6}
  
 # 6
  grid.arrange( fig.3.9.6, fig.3.10.6, ncol=1, layout_matrix = cbind( c(1,1,2,2) ) )
  
  
```

# Overall testing rate

```{r, message=FALSE}
 # TOTALS   (fig 3.A)

  provider.rates = read_csv( csb_6  ) %>%
    rename( provider = var, csb = Est. ) %>% 
    select( -`2.5%`, -`97.5%`)
  
  test.rates = read_csv( csb_6_test  ) %>%
    rename( test = Est. ) %>% select( -`2.5%`, -`97.5%`)
  
  combined.rates = inner_join( provider.rates, test.rates)
  
  
  ylabel = "Proportion of febrile children\ntested for malaria\n"
  title = "Figure 3.A Proportion of febrile children tested for malaria, sub-Saharan Africa, 2014-2015"
    
  data = combined.rates %>%  
    mutate( tested = csb * test ) %>%
    mutate( provider = factor( provider, 
                                     levels = c( "Public", "CHW", "Charity", "Formal Private", "Informal Private", "No Treatment") ,
                                     labels = c( "Public\nhealth\nfacility", 
                                                 "Community\nhealth\nworker",
                                                 "Non-profit\nhealth\ncare",
                                                 "Formal private\nhealth\ncare", 
                                                "Inormal private\nhealth\ncare",
                                                "Not seeking\ncare outside\nof home"))
                  ) %>%
    group_by( country, survey, endyear ) %>%
    summarize( 
      percent.tested = sum( tested )
      ) 
  
  ggplot( data , aes( y = percent.tested, x = "All Porviders" ) ) + 
  scale_y_continuous( ylabel , label = percent, limits = c(0, 1) )  +
  scale_x_discrete("") +
  stat_boxplot(geom ='errorbar', width = .1, size = .2) +
  geom_boxplot(fill = 'light blue', size= .2, outlier.color = 'white', width = .5)  +
  theme_bw() +
  theme( axis.text = element_text(size=8) ,
         axis.title = element_text(size=8, hjust = .5, face = 'plain'),
         title  = element_text(size=9, face = 'bold', hjust = 0)) +
  ggtitle( title )
  
  # ggsave( "Figure 3.A.pdf")
  
  cat( "For children with fever who were tested for malaria, the median percentage was" ,
       percent( median(data$percent.tested)) )
  
  csb_6_total_tested = paste0("csb_6_total_tested", substr(now(),1,10) , ".csv")

  write_excel_csv(data,  paste0("~/Dropbox/_Malaria/Projects/WMR/", csb_6_total_tested ) )
  
  cat( "The file used for the country-wide testing rates is ", csb_6_total_tested, "\n" )
  
```

# Among children tested for malaria, where were they tested?
  
```{r}
  
  ### 
  ylabel = "Proportion of tests for malaria\n(among febrile children)\n"
  title = "Figure 3.B Proportion of tests for malaria (among febrile children) by health sector, sub-Saharan Africa, 2014-2015"
  
  data = combined.rates %>% 
    mutate( tested = csb * test ) %>%
    mutate( provider = factor( provider, 
                                     levels = c( "Public", "CHW", "Charity" , "Formal Private", 
                                                 "Informal Private", "No Treatment") ,
                                     labels = c( "Public\nhealth\nfacility", 
                                                 "Community\nhealth\nworker",
                                                 "Non-profit\nhealth\ncare",
                                                 "Formal private\nhealth\ncare", 
                                                "Inormal private\nhealth\ncare",
                                                "Not seeking\ncare outside\nof home"))
                  ) %>%
    group_by( country, survey , endyear ) %>%
    mutate( 
      total.tested = sum( tested )
      ) %>%
    group_by( country, survey, endyear, provider ) %>%
    mutate( 
      percent.of.tested = tested / total.tested
      )
  
  csb_6_where_tested = paste0("csb_6_where_tested", substr(now(),1,10) , ".csv")

  write_excel_csv(data,  paste0("~/Dropbox/_Malaria/Projects/WMR/", csb_6_where_tested ) )
  
  cat( "The file used to where tested is", csb_6_where_tested, "\n" )
  
  ggplot( data , 
        aes( provider, percent.of.tested)
        ) + 
  # guides(color = guide_legend()) +
  scale_y_continuous( ylabel , label = percent, limits = c(0, 1) )  +
  scale_x_discrete("") +
  stat_boxplot(geom ='errorbar', width = .1, size = .2) + 
  geom_boxplot( fill = 'light blue', size= .2, outlier.color = 'white', width = .5) +
  theme_bw() +
  theme( axis.text = element_text(size=8) ,
         axis.title = element_text(size=8, hjust = .5, face = 'plain'),
         title  = element_text(size=9, face = 'bold', hjust = 0)) +
  ggtitle( title )
  
  # ggsave( "Figure 3.B.5categories.pdf")
  
   
```

# Trends in last decade
## care-seeking
```{r, include=FALSE}

options(survey.lonely.psu="adjust")
options(survey.adjust.domain.lonely=TRUE)

  x.provider.3b = x.provider.l %>%  
    group_by( iso3c, survey, startyear, endyear, id, hv021, hv023, weight.c, h47, care_level3b) %>%
    summarise( value = max( value, na.rm = TRUE ) ) %>% ungroup() %>%
    spread( care_level3b, value)   # return to one record per person
  
  write_excel_csv(x.provider.3b, "~/Dropbox/_Malaria/Projects/WMR/csb_survey_data_wmr2016.csv")
   
  
  data = x.provider.3b
  care_cols = c( "HMIS", "Non-HMIS", "No Treatment") 
  

  estimates_all_3b = NULL

for ( .var in care_cols ){
  estimates = list()
  
for ( i in seq_along( rownames(x.list)  )){

  .country = x.list$country[i]
  .iso3c = countrycode( .country, "country.name", "iso3c")
  .survey = x.list$survey[i]
  .year = x.list$year[i]
  .startyear = as.integer( substr( x.list$year[i], 1, 4) )
  .endyear = as.integer(
                        ifelse( nchar(x.list$year[i])>4, 
                              paste0("20", substr( x.list$year[i], 6, 7 )), 
                              substr( x.list$year[i], 1, 4 ) )
                        )
  .survey_year =  paste(.survey, .year)

  cat( .country, .survey, .year, "\n") 
  
  xx = data %>% 
    filter( iso3c %in% .iso3c ,
            survey %in% .survey , 
            startyear %in% .startyear ,
           !is.na(hv021)  # survey design object, below, requires non missing value for psu (hv021)
           )  %>%
    # select_( "iso3c", "startyear", "endyear", "survey", "hv021", "weight.c", .dots = care_cols_ ) %>%
    select_( "iso3c", "startyear", "endyear",   "survey", "hv021", "hv023", "weight.c",
             .dots =  c( "HMIS", "`Non-HMIS`", "`No Treatment`") ) 
  
  # if no survey, or no values, move on
  if ( nrow(xx) == 0) next 
  if ( sum(is.na( xx[, .var])) == nrow(xx) ) next 
  
  
  # Survey design object 
    
  unique( with(xx, paste(iso3c, survey, startyear)) )
    
    # test if strata exists; some surveys have no strata (e.g. madagascar mis 2011)
    has.strata.023 = nrow( as.data.frame.table( table(xx$hv023) ) ) > 1

    if (has.strata.023) { # urban/rural
      strataformula.c = as.formula("~hv023 ")
    } else {
        strataformula.c = NULL
    }
    
    svy.x.c  <- 
              svydesign( 
                ~hv021  , # psu 
                strata = strataformula.c , 
                data =  xx, 
                weights = ~ weight.c
              )  
  
  # survey eSTIMATES   
  
    # convert svyciprop to df
    p = svyciprop( as.formula( paste0("~`",.var, "`") ), svy.x.c, method="lo")
    pp = cbind( as.numeric(p), as.data.frame( t(attributes(p)$ci) ) )
    names(pp)[1] = "Est."
    pp$var = names(p)
    cat( paste( pp, collapse = " ") , "\n")
    
    estimates[[i]] = bind_cols(  data_frame( country = .country,
                                             iso3 = .iso3c,
                                             startyear = .startyear,
                                             endyear = .endyear,
                                             survey = .survey
                                             ) ,
                                 pp
    )
  
  }
  
estimates_var = rbindlist(estimates, fill = TRUE) %>% rownames_to_column("id")

if ( is.null(estimates_all_3b) ){
  estimates_all_3b = estimates_var
  } else {
    estimates_all_3b = bind_rows( estimates_var , estimates_all_3b)
}

}

  csb_3_trend = paste0("csb_3_trend", substr(now(),1,10) , ".csv")

  write_excel_csv(estimates_all_3b,  paste0("~/Dropbox/_Malaria/Projects/WMR/", csb_3_trend ) )
  

  # count( estimates_all_3b, endyear)
```


```{r }
## plot TREND 

  cat( "The data file used for plotting trends in care seeking is", csb_3_trend, "\n" )

  care_cols = c( "HMIS", "Non-HMIS", "No Treatment") 
  
  data = estimates_all_3b %>% 
    rename( provider = var, percent = Est. ) %>%
    mutate( provider = factor( provider, 
                                     levels = c( "HMIS", "Non-HMIS", "No Treatment") ,
                                     labels = c("Public health\nfacility", "Private\nhealth care",
                                                "Not seeking care\noutside of home"))
                  )
  
  # count( data, country, startyear, endyear, survey)
  
  # Add population < 5  for re-weighting 
  pop05 = readRDS( "../Populations/pop05_africa.RDS") %>%
    mutate( iso3 = countrycode( iso2c, "iso2c", "iso3c"))
  
  # join pop estimates
  data = data %>% as.data.frame %>% 
    inner_join(pop05[, c("iso3", "year", "pop")],
                     by = c("endyear" = "year", "iso3" = "iso3")
                     )
  
  ylabel = "Proportion of febrile children\npresenting for treatment\n"
  
  fig.3.9.trend = 
    ggplot( data , 
        aes( endyear, percent, group = provider, color = provider)
        ) + 
  # guides(color = guide_legend()) +
  scale_y_continuous( ylabel , label = percent, limits = c(0, 1) )  +
  scale_x_continuous("", breaks = 2005:2015) +
  scale_size( guide = FALSE ) +
  scale_color_brewer( type = 'qual') +
    # geom_point( alpha = .5) + # , aes(size = pop)
  geom_jitter( width = .3, alpha = .5) +
  geom_smooth(se = FALSE) +
  theme_bw() +
  theme( axis.text = element_text(size=8) ,
         axis.title = element_text(size=8, hjust = .5, face = 'plain'),
         title  = element_text(size=9, face = 'bold', hjust = 0),
         legend.position = "top") +
  ggtitle( "Figure 3.IX Proportion of febrile children presenting for treatment, by health sector, sub-Saharan Africa, 2014-2015")
  
  # fig.3.9.trend
  
  # ggsave( "Figure 3.9.trend.pdf")
  
```


## Testing rates
  
```{r, include=FALSE}

options(survey.lonely.psu="adjust")
options(survey.adjust.domain.lonely=TRUE)

  x.provider.3b = x.provider.l %>%  
    filter( endyear >= 2006 ) %>% 
    group_by( iso3c, survey, startyear, endyear, id, hv021, hv023, weight.c, h47, care_level3b) %>%
    summarise( value = max( value, na.rm = TRUE ) ) %>% ungroup() %>%
    spread( care_level3b, value)   # return to one record per person

  data = x.provider.3b %>% mutate( h47 = ifelse(h47 %in% 8:9, NA, h47))
 
  estimates_all_3b = NULL
  
  for ( .var in care_cols ){
    estimates = list()
    
  for ( i in seq_along( rownames(x.list)  )){
  
    .country = x.list$country[i]
    .iso3c = countrycode( .country, "country.name", "iso3c")
    .survey = x.list$survey[i]
    .year = x.list$year[i]
    .startyear = as.integer( substr( x.list$year[i], 1, 4) )
    .endyear = as.integer(
                          ifelse( nchar(x.list$year[i])>4, 
                                paste0("20", substr( x.list$year[i], 6, 7 )), 
                                substr( x.list$year[i], 1, 4 ) )
                          )
    .survey_year =  paste(.survey, .year)
  
    cat( .country, .survey, .year, "\n") 
    
    xx = data %>% 
      filter( iso3c %in% .iso3c ,
              survey %in% .survey , 
              startyear %in% .startyear ,
             !is.na(hv021)  # survey design object, below, requires non missing value for psu (hv021)
             )  %>%
      select_( "iso3c", "startyear", "endyear",   "survey", "hv021", "hv023", "weight.c", "h47",
               .dots =  c( "HMIS", "`Non-HMIS`", "`No Treatment`") )  %>%
      ungroup
    
    # if no survey, or no values, move on
    if ( nrow(xx) == 0) next 
    if ( sum(is.na( xx[, .var])) == nrow(xx) ) next 
    
    
    # Survey design object 
      
    cat( unique( with(xx, paste(iso3c, survey, startyear, .var)) ), "\n" )
      
      # test if strata exists; some surveys have no strata (e.g. madagascar mis 2011)
      has.strata.023 = nrow( as.data.frame.table( table(xx$hv023) ) ) > 1
  
      if (has.strata.023) { # urban/rural
        strataformula.c = as.formula("~hv023 ")
      } else {
          strataformula.c = NULL
      }
      
      svy.x.c  <- 
                svydesign( 
                  ~hv021  , # psu 
                  strata = strataformula.c , 
                  data =  xx, 
                  weights = ~ weight.c
                )  
    
    # survey eSTIMATES   

      if ( .var == "HMIS") subset.design = subset(svy.x.c, HMIS == 1 ) 
      if ( .var == "No Treatment") subset.design = subset(svy.x.c, `No Treatment` == 1 ) 
      if ( .var == "Non-HMIS") subset.design = subset(svy.x.c, `Non-HMIS` == 1 ) 
        
      # test is subset has values
      if ( nrow(subset.design) == 0 ) next 
      if ( sum(is.na( subset.design$variables$h47)) == nrow(subset.design) ) next 
    
     # convert svyciprop to df
      # p = svyciprop( as.formula( paste0("~`",.var, "`") ), svy.x.c, method="lo")
      p = svyciprop( ~h47, subset.design, method="lo")
      
      pp = cbind( as.numeric(p), as.data.frame( t(attributes(p)$ci) ) )
      names(pp)[1] = "Est."
      pp$var = names(p)
      cat( paste( pp, collapse = " ") , "\n")
      
      estimates[[i]] = bind_cols(  data_frame( country = .country,
                                               iso3 = .iso3c,
                                               startyear = .startyear,
                                               endyear = .endyear,
                                               survey = .survey,
                                               provider = .var
                                               ) ,
                                   pp
      )
    
    }
    
  estimates_var = rbindlist(estimates, fill = TRUE) %>% rownames_to_column("id")
  
  if ( is.null(estimates_all_3b) ){
    estimates_all_3b = estimates_var
    } else {
      estimates_all_3b = bind_rows( estimates_var , estimates_all_3b)
  }
  
  }
  
  
  csb_3_testing_trend = paste0("csb_3_testing_trend", substr(now(),1,10) , ".csv")

  write_excel_csv(estimates_all_3b,  csb_3_testing_trend )
  
  # estimates_all_3b = read_csv( csb_3_testing_trend )
  
  care_cols = c( "HMIS", "Non-HMIS", "No Treatment") 
  
  
  data = estimates_all_3b %>% 
    rename( percent = Est. ) %>%
    mutate( provider = factor( provider, 
                                     levels = c( "HMIS", "Non-HMIS", "No Treatment") ,
                                     labels = c("Public health\nfacility", "Private health\ncare",
                                                "Not seeking care\noutside of home")),
            endyear = factor( endyear, levels = 2006:2015)
                  )
  

```

```{r}

  cat( "The data file used for plotting trends in testing by provider is", csb_3_testing_trend, "\n" )

  ylabel = "Proportion of febrile children\npresenting for treatment\n"
  
  fig.3.10.trend = 
    ggplot( data , 
        aes( endyear, percent, group = provider, color = provider)
        ) + 
  # guides(color = guide_legend()) +
  scale_y_continuous( ylabel , label = percent, limits = c(0, 1) )  +
  scale_x_discrete("") +
  scale_size( guide = FALSE ) +
  scale_color_brewer( type = 'qual', guide = FALSE) +
  # geom_point( alpha = .5) + # , aes(size = pop)
  geom_jitter( width = .3, alpha = .5) +
  geom_smooth(se = FALSE) +
  theme_bw() +
  theme( axis.text = element_text(size=8) ,
         axis.title = element_text(size=8, hjust = .5, face = 'plain'),
         title  = element_text(size=9, face = 'bold', hjust = 0)) +
  ggtitle( "Figure 3.X Proportion of febrile children tested for malaria, by health sector, sub-Saharan Africa, 2014-2015")
  
  # fig.3.10.trend
  
  # ggsave( "Figure 3.10.trend.pdf")
 
```

```{r, fig.height= 6}
    
  grid.arrange( fig.3.9.trend, fig.3.10.trend, ncol=1, layout_matrix = cbind( c(1,1,1,1,2,2,2) ) )
  # ggsave( "Figure 3.9.and.10.trend.pdf")
 
```

