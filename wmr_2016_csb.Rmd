---
title: "wmr_2016_csb"
author: "jp"
date: "10/25/2016"
output: word_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, cache = TRUE)
```

```{r, include = FALSE}
library(data.table)
library(tidyverse)
library(scales)
library(survey)
library(knitr)
library(gridExtra)
library(countrycode)
library(readr)
library(readxl)
library(survey)  
options(survey.lonely.psu="adjust")
options(survey.adjust.domain.lonely=TRUE)
```

# Main data 

```{r, include = FALSE}
x = readRDS("provider_subset.rds")
```

## subset to available surveys in Sub-saharan Africa from 2006 to 2016: 

```{r}

subsahara = countrycode_data %>%
  filter( region %in% c("Middle Africa", "Western Africa", "Eastern Africa", "Southern Africa")) %>% 
  select( country.name, iso3c ) %>%
  filter( !country.name %in% "Lesotho") 

x = x %>% 
  mutate( startyear = as.integer( substr( year, 1, 4 ) ),
            endyear = as.integer(
              ifelse( nchar(year)>4, 
                              paste0("20", substr( year, 6, 7 )), 
                              substr( year, 1, 4 ))
            )
            ) %>%
  filter( endyear >= 2006, 
          iso3c %in% subsahara$iso3c ) %>% 
  as.data.table()

x.list = x %>% count( country, survey, year ) %>% arrange(desc(year) )

kable( x.list %>% select(-n) , row.names = TRUE)


```

## lookup provider (h32) values and translate to care level 

```{r}

# originally used 2014 file to map dhs values to one of 16 WMR defined provider types
# csb_mapped_2014 <- read_csv("~/Dropbox/_Malaria/Projects/WMR/csb_final_mapped_17Oct2014.csv",
#                             locale = locale(encoding = "WINDOWS-1252"))

# then added values from later surveys...so now open _2016 file
# csb_mapped_2016 <- read_csv("~/Dropbox/_Malaria/Projects/WMR/csb_mapped_2016.csv",
#                             locale = locale(encoding = "WINDOWS-1252"))

csb_mapped_2016 <- read_excel("~/Dropbox/_Malaria/Projects/WMR/csb_mapped_october24_2016.xlsx")

# csb_mapped = csb_mapped_2016 %>% 
#   filter( endyear >= 2006 ) %>%
#   mutate( varlab = tolower( varlab)) %>%
#   count( varlab, care_level ) %>% 
#   spread( care_level , n) %>%  
#   gather( care_level, n, -varlab) %>% 
#   filter( n>0 ) %>% 
#   select(-n)
# 
#  kable( csb_mapped %>% count( iso3, startyear ) %>% arrange(desc(startyear) ) , row.names = TRUE)

 csb_levels = read_excel("~/Dropbox/_Malaria/Projects/WMR/care_levels.xlsx") %>% as.data.frame()

 
# selet needed columns from dataset
xp = x %>%
    select( country, iso3c, startyear, year, survey, hv021, hv023, weight.c, starts_with("h32"), h47) %>%
    mutate( id = row_number() )  %>%
    ungroup
 
#  # kable( xp %>% count( country, survey, year ) %>% arrange(desc(year) ) , row.names = TRUE)
#  
# # get dictionary vales from children's file 
# 
#   dd <-readRDS("dictionaryNew.rds")  # about 6 sec
# 
#   ddc = dd %>% ungroup %>% 
#     filter( grepl( "Children", file ) | grepl( "kr", file )
#             ) %>%
#     mutate(
#       startyear = as.integer( substr( year, 1, 4 ) ) ,
#       Item_Label = tolower( Item_Label ) ,
#       Item_Name = tolower( Item_Name)
#     ) %>%
#     count( country, survey, startyear, Item_Name, Item_Label) %>% ungroup()
# 
#   kable( ddc %>% count( country, survey, startyear ) %>% arrange(desc(startyear) ) , row.names = TRUE)


```

```{r}
## transform dataset to long format by provider 
  xl = xp %>% 
    gather(provider, value, -country, -iso3c, -startyear, -year, -survey, -hv021, -hv023, -weight.c, -h47, -id)  %>%
    mutate( provider = tolower(provider),
            value = as.character(value)) %>%
    filter( !(provider %in% 'h32z') ) %>%  # remove all the 'no provider' 
    filter( !is.na(value)) # remove unused providers

  # join with dictionary file to get labels for each variable
  # xld = xl %>% 
  #   left_join(ddc, by = c('country' = 'country', 'survey' = 'survey', 'startyear' = 'startyear', 
  #                          'provider' = 'Item_Name' ) ) %>%
  #   select(-n)
  xld = xl # bypass dictionary step and lookup on variable name instead of label
 
  # lookup care_levels for each  provider
  
  csb_map = csb_mapped_2016 %>%
    group_by( iso3, startyear, varname ) %>%
    summarise( care_level = first(care_level))
  
  # View( count(csb_map, iso3, startyear,care_level) %>% spread( care_level, n) )
  
  xld$care_level = as.integer( csb_map[ match( 
    paste(xld$iso3c, xld$startyear, xld$provider), 
    paste(csb_map$iso3, csb_map$startyear, csb_map$varname) 
    ),]$care_level )
  


  
  ## transform back to wide format with provider 
  
  x.provider.l = xld %>% 
    mutate( startyear = as.integer( substr( year, 1, 4 ) ),
            endyear = as.integer(
                        ifelse( nchar(year)>4, 
                              paste0("20", substr( year, 6, 7 )), 
                              substr( year, 1, 4 ) )
                        ),
              value = as.integer( ifelse( value %in% "9", NA, value ) )  # replace 9 with NA, convert to int
    ) %>%
    group_by( iso3c, survey, startyear, endyear, id, hv021,  hv023, weight.c, h47, care_level) %>%
    summarise( value = max( value, na.rm = TRUE ) ) %>% ungroup() %>%
    filter( !is.na( care_level )) 

### define grouping levels  
x.provider.l$care_level6 = csb_levels[ match(x.provider.l$care_level, csb_levels$care_level), "care_level_6"]
x.provider.l$care_level5 = csb_levels[ match(x.provider.l$care_level, csb_levels$care_level), "care_level_5"]
x.provider.l$care_level4 = csb_levels[ match(x.provider.l$care_level, csb_levels$care_level), "care_level_4"]
x.provider.l$care_level3 = csb_levels[ match(x.provider.l$care_level, csb_levels$care_level), "care_level_3"]
x.provider.l$care_level3b = csb_levels[ match(x.provider.l$care_level, csb_levels$care_level), "care_level_3b"]
    
x.provider.w = x.provider.l %>% spread( care_level, value) 
  
# NB: because the h32z variable, 'medical treatment', is coded in survey as summary when any 
# of the the providers are chosen, we don't want to count it as a type of provider.  It just means 
# a provider was selected.  But the csb file maps these to 'other', which result in double counting.
# So--the column h32z is now removed in an earlier step ( see creation of xl dataset, above).  
# Note that h32y, 'no treatment' is still included.  

```

## save dataset to excel
```{r}
write_excel_csv(x.provider.l, "~/Dropbox/_Malaria/Projects/WMR/csb_survey_long_wmr2016.csv")

```

### Data checks-- find rows with missing care_level--and updateing csb excel files
```{r, eval=FALSE}
    
  
    # look at un-joined....
  xxx = xld %>% filter( is.na(care_level)) %>% count( country, survey, year)
  
  # remove rows with mising labels
  xld. = xld %>% filter( !is.na(Item_Label))

  table(  xld.$care_level, useNA = 'always')

  xld.m = xld. %>%
    filter( is.na( care_level)) %>%
    rename( iso3 = iso3c,
            varname = provider,
            varlab = Item_Label,
            filename = survey) %>%
    mutate( startyear = as.integer( substr( year, 1, 4 ) ),
            endyear = as.integer(
              ifelse( nchar(year)>4,
                              paste0("20", substr( year, 6, 7 )),
                              substr( year, 1, 4 ))
            )
            ) %>%
  count( iso3, startyear, endyear, filename, varname, varlab)

  # View( xld.m )
  
  # Add the missing labels back to the csb_mapped file (then comment out lines so not re-run) #
    # 1.
    # add_csb_mapped = xld.m %>%  ungroup %>%
    #   select(iso3, startyear, endyear, filename, varname, varlab)
    #
    # csb_mapped_2016 = bind_rows( csb_mapped_2016, add_csb_mapped)
    # write_excel_csv(csb_mapped_2016, "~/Dropbox/_Malaria/Projects/WMR/csb_mapped_2016.csv")

    # 2. go to excel/csv file and classify the care_levels to be consistent with previous categorizations
    # 3. re-make csb_mapped, line 52, and re-run to here
    
```


### (run once after loading new data) 
```{r, eval=FALSE}

# how many kids sought care at more than one type of provider
care_cols = c("CHW", "Public", "Formal Private", "Informal Private") 

x.provider.5 = x.provider.l %>%  
  group_by( iso3c, survey, startyear, endyear, id, hv021, hv023, weight.c, h47, care_level5) %>%
  summarise( value = max( value, na.rm = TRUE ) ) %>% ungroup() %>%
  spread( care_level5, value)   # return to one record per person

x.provider.5 = data.table(x.provider.5)
x.provider.5 = x.provider.5[ , nprovider := rowSums( .SD , na.rm = TRUE), .SDcols = care_cols]                           

count(x.provider.5, nprovider)  # only 444 /(8281+14425+436+8), 1.9%, had>1 provider type

z = xl %>% group_by(id) %>%
  summarise( sz = sum( ifelse( provider %in% 'h32z', as.integer(value), 0 ) ) ,
             sy = sum( ifelse( provider %in% 'h32y', as.integer(value), 0 ) ) ,
             so = sum( ifelse( provider %in% c('h32z','h32y'), 0, as.integer(value) ), na.rm = TRUE )
             )

sum( z$sy == 1 & z$so>0 )  # is there ever a provider selected (so>0) and 'no provider'?  0

sum( z$so == 0 & z$sz>0 , na.rm=TRUE) # is there ever any provider selected (sz>0) and no specific provider (so==0)?  0

sum( z$so>0 & z$sz>0 , na.rm=TRUE) ; sum( z$so>0); sum( z$sz>0, na.rm = TRUE)
```


# Estimates  
## Providers for care seeking
## 4 levels 
```{r, include=FALSE}

  x.provider.4 = x.provider.l %>%  
    filter( endyear >= 2014 ) %>% 
    group_by( iso3c, survey, startyear, endyear, id, hv021, hv023, weight.c, h47, care_level4) %>%
    summarise( value = max( value, na.rm = TRUE ) ) %>% ungroup() %>%
    spread( care_level4, value)   # return to one record per person
  
  write_excel_csv(x.provider.4, "~/Dropbox/_Malaria/Projects/WMR/csb_survey_data_wmr2016.csv")
   
  
  data = x.provider.4
  care_cols = c( "Public", "Formal Private", "Informal Private", "No Treatment") 
  

  estimates_all_4 = NULL

for ( .var in care_cols ){
  estimates = list()
  
for ( i in seq_along( rownames(x.list)  )){

  .country = x.list$country[i]
  .iso3c = countrycode( .country, "country.name", "iso3c")
  .survey = x.list$survey[i]
  .year = x.list$year[i]
  .startyear = as.integer( substr( x.list$year[i], 1, 4) )
  .endyear = as.integer(
                        ifelse( nchar(x.list$year[i])>4, 
                              paste0("20", substr( x.list$year[i], 6, 7 )), 
                              substr( x.list$year[i], 1, 4 ) )
                        )
  .survey_year =  paste(.survey, .year)

  cat( .country, .survey, .year, "\n") 
  
  xx = data %>% 
    filter( iso3c %in% .iso3c ,
            survey %in% .survey , 
            startyear %in% .startyear ,
           !is.na(hv021)  # survey design object, below, requires non missing value for psu (hv021)
           )  %>%
    # select_( "iso3c", "startyear", "endyear", "survey", "hv021", "weight.c", .dots = care_cols_ ) %>%
    select_( "iso3c", "startyear", "endyear",   "survey", "hv021", "hv023", "weight.c",
             .dots = c("Public", "`Formal Private`", "`Informal Private`", "`No Treatment`")  ) %>%
    ungroup
  
  # if no survey, or no values, move on
  if ( nrow(xx) == 0) next 
  if ( sum(is.na( xx[, .var])) == nrow(xx) ) next 
  
  
  # Survey design object 
    
  unique( with(xx, paste(iso3c, survey, startyear)) )
    
    # test if strata exists; some surveys have no strata (e.g. madagascar mis 2011)
    has.strata.023 = nrow( as.data.frame.table( table(xx$hv023) ) ) > 1

    if (has.strata.023) { # urban/rural
      strataformula.c = as.formula("~hv023 ")
    } else {
        strataformula.c = NULL
    }
    
    svy.x.c  <- 
              svydesign( 
                ~hv021  , # psu 
                strata = strataformula.c , 
                data =  xx, 
                weights = ~ weight.c
              )  
  
  # survey eSTIMATES   
  options(survey.lonely.psu="adjust")
  options(survey.adjust.domain.lonely=TRUE)


    # convert svyciprop to df
    p = svyciprop( as.formula( paste0("~`",.var, "`") ), svy.x.c, method="lo")
    pp = cbind( as.numeric(p), as.data.frame( t(attributes(p)$ci) ) )
    names(pp)[1] = "Est."
    pp$var = names(p)
    cat( paste( pp, collapse = " ") , "\n")
    
    estimates[[i]] = bind_cols(  data_frame( country = .country,
                                             iso3 = .iso3c,
                                             startyear = .startyear,
                                             endyear = .endyear,
                                             survey = .survey
                                             ) ,
                                 pp
    )
  
  }
  
estimates_var = rbindlist(estimates, fill = TRUE) %>% rownames_to_column("id")

if ( is.null(estimates_all_4) ){
  estimates_all_4 = estimates_var
  } else {
    estimates_all_4 = bind_rows( estimates_var , estimates_all_4)
}

}

  # View(estimates_all_4)
  write_excel_csv(estimates_all_4, "~/Dropbox/_Malaria/Projects/WMR/csb_survey_summary_wmr2016.csv")

  est = estimates_all_4 %>% select(-`2.5%`, -`97.5%`) %>% spread(var, Est.)
  write_excel_csv(est, "~/Dropbox/_Malaria/Projects/WMR/John3.9.4.csv")



```

```{r}
## plots... 4 levels 

  care_cols = c( "Public", "Formal Private", "Informal Private", "No Treatment") 
  
  data = estimates_all_4 %>% filter( endyear>2013) %>% 
    rename( provider = var, percent = Est. ) %>%
    mutate( provider = factor( provider, 
                                     levels = c( "Public", "Formal Private", "Informal Private", "No Treatment") ,
                                     labels = c("Public health\nfacility", 
                                                "Formal private\nhealth care", 
                                                "Inormal private\nhealth care",
                                                "Not seeking care\noutside of home"))
                  )
  
  # count( data, country, startyear, endyear, survey)
  
  ylabel = "Proportion of febrile children\npresenting for treatment\n"
  
  fig.3.9.4 = ggplot( data , 
        aes( provider, percent)
        ) + 
  # guides(color = guide_legend()) +
  scale_y_continuous( ylabel , label = percent, limits = c(0, 1) )  +
  scale_x_discrete("") +
  stat_boxplot(geom ='errorbar', width = .1, size = .2) + 
  geom_boxplot( fill = 'light blue', size= .2, outlier.color = 'white', width = .5) +
  theme_bw() +
  theme( axis.text = element_text(size=8) ,
         axis.title = element_text(size=8, hjust = .5, face = 'plain'),
         title  = element_text(size=9, face = 'bold', hjust = 0)) +
  ggtitle( "Figure 3.9 Proportion of febrile children presenting for treatment,\nby health sector, sub-Saharan Africa, 2014-2015")
  
  fig.3.9.4
  
  # ggsave( "Figure 3.9.4categories.pdf")
  
```

## 5 levels 
```{r, include=FALSE}
   
  care_cols = c( "Public", "Formal Private", "Informal Private", "No Treatment") 
  
  x.provider.5 = x.provider.l %>%  
    filter( endyear >= 2014 ) %>% 
    group_by( iso3c, survey, startyear, endyear, id, hv021, hv023, weight.c, h47, care_level5) %>%
    summarise( value = max( value, na.rm = TRUE ) ) %>% ungroup() %>%
    spread( care_level5, value)   # return to one record per person

   data = x.provider.5
   care_cols = c( "Public", "CHW", "Formal Private", "Informal Private", "No Treatment") 
   .var = "Formal Private"

  estimates_all_5 = NULL
  
  for ( .var in care_cols ){
    estimates = list()
    
  for ( i in seq_along( rownames(x.list)  )){
  
    .country = x.list$country[i]
    .iso3c = countrycode( .country, "country.name", "iso3c")
    .survey = x.list$survey[i]
    .year = x.list$year[i]
    .startyear = as.integer( substr( x.list$year[i], 1, 4) )
    .endyear = as.integer(
                          ifelse( nchar(x.list$year[i])>4, 
                                paste0("20", substr( x.list$year[i], 6, 7 )), 
                                substr( x.list$year[i], 1, 4 ) )
                          )
    .survey_year =  paste(.survey, .year)
  
    cat( .country, .survey, .year, "\n") 
    
    xx = data %>% 
      filter( iso3c %in% .iso3c ,
              survey %in% .survey , 
              startyear %in% .startyear ,
             !is.na(hv021)  # survey design object, below, requires non missing value for psu (hv021)
             )  %>%
      # select_( "iso3c", "startyear", "endyear", "survey", "hv021", "weight.c", .dots = care_cols_ ) %>%
      select_( "iso3c", "startyear", "endyear",   "survey", "hv021", "hv023", "weight.c",
               .dots = c("Public", "CHW" , "`Formal Private`", "`Informal Private`", "`No Treatment`")  ) %>%
      ungroup
    
    # if no survey, or no values, move on
    if ( nrow(xx) == 0) next 
    if ( sum(is.na( xx[, .var])) == nrow(xx) ) next 
    
    
    # Survey design object 
      
    unique( with(xx, paste(iso3c, survey, startyear)) )
      
      # test if strata exists; some surveys have no strata (e.g. madagascar mis 2011)
      has.strata.023 = nrow( as.data.frame.table( table(xx$hv023) ) ) > 1
  
      if (has.strata.023) { # urban/rural
        strataformula.c = as.formula("~hv023 ")
      } else {
          strataformula.c = NULL
      }
      
      svy.x.c  <- 
                svydesign( 
                  ~hv021  , # psu 
                  strata = strataformula.c , 
                  data =  xx, 
                  weights = ~ weight.c
                )  
    
    # survey eSTIMATES   
    
      # convert svyciprop to df
      p = svyciprop( as.formula( paste0("~`",.var, "`") ), svy.x.c, method="lo")
      pp = cbind( as.numeric(p), as.data.frame( t(attributes(p)$ci) ) )
      names(pp)[1] = "Est."
      pp$var = names(p)
      cat( paste( pp, collapse = " ") , "\n")
      
      estimates[[i]] = bind_cols(  data_frame( country = .country,
                                               iso3 = .iso3c,
                                               startyear = .startyear,
                                               endyear = .endyear,
                                               survey = .survey
                                               ) ,
                                   pp
      )
    
    }
    
  estimates_var = rbindlist(estimates, fill = TRUE) %>% rownames_to_column("id")
  
  if ( is.null(estimates_all_5) ){
    estimates_all_5 = estimates_var
    } else {
      estimates_all_5 = bind_rows( estimates_var , estimates_all_5)
  }
  
  }
  
  # View(estimates_all_5)
  write_excel_csv(estimates_all_5, "~/Dropbox/_Malaria/Projects/WMR/csb_survey_summary5_wmr2016.csv")
  
  est = estimates_all_5 %>% select(-`2.5%`, -`97.5%`) %>% spread(var, Est.)
  write_excel_csv(est, "~/Dropbox/_Malaria/Projects/WMR/John3.9.5.csv")


```
  
```{r}
## Plot provider (3.9) 5 levels
  data = estimates_all_5 %>% filter( endyear>2013) %>% 
    rename( provider = var, percent = Est. ) %>%
    mutate( provider = factor( provider, 
                                     levels = c( "Public", "CHW", "Formal Private", "Informal Private", "No Treatment") ,
                                     labels = c( "Public health\nfacility", 
                                                 "Community health\nworker",
                                                 "Formal private\nhealth care", 
                                                "Inormal private\nhealth care",
                                                "Not seeking care\noutside of home"))
                  )
  
  # count( data, country, startyear, endyear, survey)
  
  ylabel = "Proportion of febrile children\npresenting for treatment\n"
  
  fig.3.9.5 = ggplot( data , 
        aes( provider, percent)
        ) + 
  # guides(color = guide_legend()) +
  scale_y_continuous( ylabel , label = percent, limits = c(0, 1) )  +
  scale_x_discrete("") +
  stat_boxplot(geom ='errorbar', width = .1, size = .2) + 
  geom_boxplot( fill = 'light blue', size= .2, outlier.color = 'white', width = .5) +
  theme_bw() +
  theme( axis.text = element_text(size=8) ,
         axis.title = element_text(size=8, hjust = .5, face = 'plain'),
         title  = element_text(size=9, face = 'bold', hjust = 0)) +
  ggtitle( "Figure 3.9 Proportion of febrile children presenting for treatment,\nby health sector, sub-Saharan Africa, 2014-2015")
  
  fig.3.9.5
  
  # ggsave( "Figure 3.9.5categories.pdf")
  
  
```

## 6 levels 
```{r, include=FALSE}
    
  x.provider.6 = x.provider.l %>%  
    filter( endyear >= 2014 ) %>% 
    group_by( iso3c, survey, startyear, endyear, id, hv021, hv023, weight.c, h47, care_level6) %>%
    summarise( value = max( value, na.rm = TRUE ) ) %>% ungroup() %>%
    spread( care_level6, value)   # return to one record per person

   data = x.provider.6
   care_cols = c( "Public", "CHW", "Charity" , "Formal Private", "Informal Private", "No Treatment") 

  estimates_all_6 = NULL
  
  for ( .var in care_cols ){
    estimates = list()
    
  for ( i in seq_along( rownames(x.list)  )){
  
    .country = x.list$country[i]
    .iso3c = countrycode( .country, "country.name", "iso3c")
    .survey = x.list$survey[i]
    .year = x.list$year[i]
    .startyear = as.integer( substr( x.list$year[i], 1, 4) )
    .endyear = as.integer(
                          ifelse( nchar(x.list$year[i])>4, 
                                paste0("20", substr( x.list$year[i], 6, 7 )), 
                                substr( x.list$year[i], 1, 4 ) )
                          )
    .survey_year =  paste(.survey, .year)
  
    cat( .country, .survey, .year, "\n") 
    
    xx = data %>% 
      filter( iso3c %in% .iso3c ,
              survey %in% .survey , 
              startyear %in% .startyear ,
             !is.na(hv021)  # survey design object, below, requires non missing value for psu (hv021)
             )  %>%
      # select_( "iso3c", "startyear", "endyear", "survey", "hv021", "weight.c", .dots = care_cols_ ) %>%
      select_( "iso3c", "startyear", "endyear",   "survey", "hv021", "hv023", "weight.c",
               .dots = c("Public", "Charity", "CHW" , "`Formal Private`", "`Informal Private`", "`No Treatment`")  ) %>%
      ungroup
    
    # if no survey, or no values, move on
    if ( nrow(xx) == 0) next 
    if ( sum(is.na( xx[, .var])) == nrow(xx) ) next 
    
    
    # Survey design object 
      
    unique( with(xx, paste(iso3c, survey, startyear)) )
      
      # test if strata exists; some surveys have no strata (e.g. madagascar mis 2011)
      has.strata.023 = nrow( as.data.frame.table( table(xx$hv023) ) ) > 1
  
      if (has.strata.023) { # urban/rural
        strataformula.c = as.formula("~hv023 ")
      } else {
          strataformula.c = NULL
      }
      
      svy.x.c  <- 
                svydesign( 
                  ~hv021  , # psu 
                  strata = strataformula.c , 
                  data =  xx, 
                  weights = ~ weight.c
                )  
    
    # survey eSTIMATES   
    
      # convert svyciprop to df
      p = svyciprop( as.formula( paste0("~`",.var, "`") ), svy.x.c, method="lo")
      pp = cbind( as.numeric(p), as.data.frame( t(attributes(p)$ci) ) )
      names(pp)[1] = "Est."
      pp$var = names(p)
      cat( paste( pp, collapse = " ") , "\n")
      
      estimates[[i]] = bind_cols(  data_frame( country = .country,
                                               iso3 = .iso3c,
                                               startyear = .startyear,
                                               endyear = .endyear,
                                               survey = .survey
                                               ) ,
                                   pp
      )
    
    }
    
  estimates_var = rbindlist(estimates, fill = TRUE) %>% rownames_to_column("id")
  
  if ( is.null(estimates_all_6) ){
    estimates_all_6 = estimates_var
    } else {
      estimates_all_6 = bind_rows( estimates_var , estimates_all_6)
  }
  
  }
  
  # View(estimates_all_6)
  write_excel_csv(estimates_all_6, "~/Dropbox/_Malaria/Projects/WMR/csb_test_summary6_wmr2016.csv")
  
  est = estimates_all_6 %>% select(-`2.5%`, -`97.5%`) %>% spread(var, Est.)
  write_excel_csv(est, "~/Dropbox/_Malaria/Projects/WMR/John3.9.6.csv")


```

```{r}
## Plot provider (3.9) 6 levels
  data = estimates_all_6 %>% filter( endyear>2013) %>% 
    rename( provider = var, percent = Est. ) %>%
    mutate( provider = factor( provider, 
                                     levels = c( "Public", "CHW","Charity", "Formal Private", "Informal Private", "No Treatment") ,
                                     labels = c( "Public health\nfacility", 
                                                 "Community health\nworker",
                                                 "Non-profit health\ncare",
                                                 "Formal private\nhealth care", 
                                                "Inormal private\nhealth care",
                                                "Not seeking care\noutside of home"))
                  )
  
  # count( data, country, startyear, endyear, survey)
  
  ylabel = "Proportion of febrile children\npresenting for treatment\n"
  
  fig.3.9.6 = ggplot( data , 
        aes( provider, percent)
        ) + 
  # guides(color = guide_legend()) +
  scale_y_continuous( ylabel , label = percent, limits = c(0, 1) )  +
  scale_x_discrete("") +
  stat_boxplot(geom ='errorbar', width = .1, size = .2) + 
  geom_boxplot( fill = 'light blue', size= .2, outlier.color = 'white', width = .5) +
  theme_bw() +
  theme( axis.text = element_text(size=8) ,
         axis.title = element_text(size=8, hjust = .5, face = 'plain'),
         title  = element_text(size=9, face = 'bold', hjust = 0)) +
  ggtitle( "Figure 3.9 Proportion of febrile children presenting for treatment,\nby health sector, sub-Saharan Africa, 2014-2015")
  
  fig.3.9.6
  
  # ggsave( "Figure 3.9.6categories.pdf")
  
   

  
```

# Testing rates by provider
## 4 levels  
```{r, include=FALSE}
  x.provider.4 = x.provider.l %>%  
    filter( endyear >= 2014 ) %>% 
    group_by( iso3c, survey, startyear, endyear, id, hv021, hv023, weight.c, h47, care_level4) %>%
    summarise( value = max( value, na.rm = TRUE ) ) %>% ungroup() %>%
    spread( care_level4, value)   # return to one record per person

  data = x.provider.4 %>% mutate( h47 = ifelse(h47 %in% 8:9, NA, h47))
 
  care_cols = c( "Public", "Formal Private", "Informal Private", "No Treatment") 

  estimates_all_4 = NULL
  
  for ( .var in care_cols ){
    estimates = list()
    
  for ( i in seq_along( rownames(x.list)  )){
  
    .country = x.list$country[i]
    .iso3c = countrycode( .country, "country.name", "iso3c")
    .survey = x.list$survey[i]
    .year = x.list$year[i]
    .startyear = as.integer( substr( x.list$year[i], 1, 4) )
    .endyear = as.integer(
                          ifelse( nchar(x.list$year[i])>4, 
                                paste0("20", substr( x.list$year[i], 6, 7 )), 
                                substr( x.list$year[i], 1, 4 ) )
                          )
    .survey_year =  paste(.survey, .year)
  
    cat( .country, .survey, .year, "\n") 
    
    xx = data %>% 
      filter( iso3c %in% .iso3c ,
              survey %in% .survey , 
              startyear %in% .startyear ,
             !is.na(hv021)  # survey design object, below, requires non missing value for psu (hv021)
             )  %>%
      # select_( "iso3c", "startyear", "endyear", "survey", "hv021", "weight.c", .dots = care_cols_ ) %>%
      select_( "iso3c", "startyear", "endyear",   "survey", "hv021", "hv023", "weight.c", "h47",
               .dots = c("Public", "`Formal Private`", "`Informal Private`", "`No Treatment`")  ) %>%
      ungroup
    
    # if no survey, or no values, move on
    if ( nrow(xx) == 0) next 
    if ( sum(is.na( xx[, .var])) == nrow(xx) ) next 
    
    
    # Survey design object 
      
    cat( unique( with(xx, paste(iso3c, survey, startyear, .var)) ), "\n" )
      
      # test if strata exists; some surveys have no strata (e.g. madagascar mis 2011)
      has.strata.023 = nrow( as.data.frame.table( table(xx$hv023) ) ) > 1
  
      if (has.strata.023) { # urban/rural
        strataformula.c = as.formula("~hv023 ")
      } else {
          strataformula.c = NULL
      }
      
      svy.x.c  <- 
                svydesign( 
                  ~hv021  , # psu 
                  strata = strataformula.c , 
                  data =  xx, 
                  weights = ~ weight.c
                )  
    
    # survey eSTIMATES   

      if ( .var == "CHW") subset.design = subset(svy.x.c, CHW == 1 ) 
      if ( .var == "Charity") subset.design = subset(svy.x.c, Charity == 1 ) 
      if ( .var == "Public") subset.design = subset(svy.x.c, Public == 1 ) 
      if ( .var == "No Treatment") subset.design = subset(svy.x.c, `No Treatment` == 1 ) 
      if ( .var == "Formal Private") subset.design = subset(svy.x.c, `Formal Private` == 1 ) 
      if ( .var == "Informal Private") subset.design = subset(svy.x.c, `Informal Private` == 1 ) 
        
      # test is subset has values
      if ( nrow(subset.design) == 0 ) next 
      if ( sum(is.na( subset.design$variables$h47)) == nrow(subset.design) ) next 
    
     # convert svyciprop to df
      # p = svyciprop( as.formula( paste0("~`",.var, "`") ), svy.x.c, method="lo")
      p = svyciprop( ~h47, subset.design, method="lo")
      
      pp = cbind( as.numeric(p), as.data.frame( t(attributes(p)$ci) ) )
      names(pp)[1] = "Est."
      pp$var = names(p)
      cat( paste( pp, collapse = " ") , "\n")
      
      estimates[[i]] = bind_cols(  data_frame( country = .country,
                                               iso3 = .iso3c,
                                               startyear = .startyear,
                                               endyear = .endyear,
                                               survey = .survey,
                                               provider = .var
                                               ) ,
                                   pp
      )
    
    }
    
  estimates_var = rbindlist(estimates, fill = TRUE) %>% rownames_to_column("id")
  
  if ( is.null(estimates_all_4) ){
    estimates_all_4 = estimates_var
    } else {
      estimates_all_4 = bind_rows( estimates_var , estimates_all_4)
  }
  
  }
  
  # View(estimates_all_4)
  write_excel_csv(estimates_all_4, "~/Dropbox/_Malaria/Projects/WMR/csb_test_summary4_wmr2016.csv")
  
```

```{r}
  ## Plot test by 4 provider (3.10) 

  data = estimates_all_4 %>% filter( endyear>2013) %>% 
    rename( percent = Est. ) %>%
    mutate( provider = factor( provider, 
                                     levels = c( "Public", "CHW", "Charity", "Formal Private", "Informal Private", "No Treatment") ,
                                     labels = c( "Public health\nfacility", 
                                                 "Community health\nworker",
                                                 "Non-profit\nhealth care", 
                                                 "Formal private\nhealth care", 
                                                "Inormal private\nhealth care",
                                                "Not seeking care\noutside of home"))
                  )
  
  # count( data, country, startyear, endyear, survey)
  
  ylabel = "Proportion of febrile children\nreceiving a blood test"
  
  fig.3.10.4 = ggplot( data , 
        aes( provider, percent)
        ) + 
  # guides(color = guide_legend()) +
  scale_y_continuous( ylabel , label = percent, limits = c(0, 1) )  +
  scale_x_discrete("") +
  stat_boxplot(geom ='errorbar', width = .1, size = .2) + 
  geom_boxplot( fill = 'light blue', size= .2, outlier.color = 'white', width = .5) +
  theme_bw() +
  theme( axis.text = element_text(size=8) ,
         axis.title = element_text(size=8, hjust = .5, face = 'plain'),
         title  = element_text(size=9, face = 'bold', hjust = 0)) +
  ggtitle( "Figure 3.10 Proportion of febrile children tested for malaria,\nby health sector, sub-Saharan Africa, 2014-2015")
  
  fig.3.10.4
  
  # ggsave( "Figure 3.10.4categories.pdf")
  


```

## 5 levels  
```{r, include=FALSE}
  x.provider.5 = x.provider.l %>%  
    filter( endyear >= 2014 ) %>% 
    group_by( iso3c, survey, startyear, endyear, id, hv021, hv023, weight.c, h47, care_level5) %>%
    summarise( value = max( value, na.rm = TRUE ) ) %>% ungroup() %>%
    spread( care_level5, value)   # return to one record per person

  data = x.provider.5 %>% mutate( h47 = ifelse(h47 %in% 8:9, NA, h47))
 
  care_cols = c( "Public", "CHW", "Formal Private", "Informal Private", "No Treatment") 

  estimates_all_5 = NULL
  
  for ( .var in care_cols ){
    estimates = list()
    
  for ( i in seq_along( rownames(x.list)  )){
  
    .country = x.list$country[i]
    .iso3c = countrycode( .country, "country.name", "iso3c")
    .survey = x.list$survey[i]
    .year = x.list$year[i]
    .startyear = as.integer( substr( x.list$year[i], 1, 4) )
    .endyear = as.integer(
                          ifelse( nchar(x.list$year[i])>4, 
                                paste0("20", substr( x.list$year[i], 6, 7 )), 
                                substr( x.list$year[i], 1, 4 ) )
                          )
    .survey_year =  paste(.survey, .year)
  
    cat( .country, .survey, .year, "\n") 
    
    xx = data %>% 
      filter( iso3c %in% .iso3c ,
              survey %in% .survey , 
              startyear %in% .startyear ,
             !is.na(hv021)  # survey design object, below, requires non missing value for psu (hv021)
             )  %>%
      # select_( "iso3c", "startyear", "endyear", "survey", "hv021", "weight.c", .dots = care_cols_ ) %>%
      select_( "iso3c", "startyear", "endyear",   "survey", "hv021", "hv023", "weight.c", "h47",
               .dots = c("Public", "CHW" , "`Formal Private`", "`Informal Private`", "`No Treatment`")  ) %>%
      ungroup
    
    # if no survey, or no values, move on
    if ( nrow(xx) == 0) next 
    if ( sum(is.na( xx[, .var])) == nrow(xx) ) next 
    
    
    # Survey design object 
      
    cat( unique( with(xx, paste(iso3c, survey, startyear, .var)) ), "\n" )
      
      # test if strata exists; some surveys have no strata (e.g. madagascar mis 2011)
      has.strata.023 = nrow( as.data.frame.table( table(xx$hv023) ) ) > 1
  
      if (has.strata.023) { # urban/rural
        strataformula.c = as.formula("~hv023 ")
      } else {
          strataformula.c = NULL
      }
      
      svy.x.c  <- 
                svydesign( 
                  ~hv021  , # psu 
                  strata = strataformula.c , 
                  data =  xx, 
                  weights = ~ weight.c
                )  
    
    # survey eSTIMATES   

      if ( .var == "CHW") subset.design = subset(svy.x.c, CHW == 1 ) 
      if ( .var == "Charity") subset.design = subset(svy.x.c, Charity == 1 ) 
      if ( .var == "Public") subset.design = subset(svy.x.c, Public == 1 ) 
      if ( .var == "No Treatment") subset.design = subset(svy.x.c, `No Treatment` == 1 ) 
      if ( .var == "Formal Private") subset.design = subset(svy.x.c, `Formal Private` == 1 ) 
      if ( .var == "Informal Private") subset.design = subset(svy.x.c, `Informal Private` == 1 ) 
        
      # test is subset has values
      if ( nrow(subset.design) == 0 ) next 
      if ( sum(is.na( subset.design$variables$h47)) == nrow(subset.design) ) next 
    
     # convert svyciprop to df
      # p = svyciprop( as.formula( paste0("~`",.var, "`") ), svy.x.c, method="lo")
      p = svyciprop( ~h47, subset.design, method="lo")
      
      pp = cbind( as.numeric(p), as.data.frame( t(attributes(p)$ci) ) )
      names(pp)[1] = "Est."
      pp$var = names(p)
      cat( paste( pp, collapse = " ") , "\n")
      
      estimates[[i]] = bind_cols(  data_frame( country = .country,
                                               iso3 = .iso3c,
                                               startyear = .startyear,
                                               endyear = .endyear,
                                               survey = .survey,
                                               provider = .var
                                               ) ,
                                   pp
      )
    
    }
    
  estimates_var = rbindlist(estimates, fill = TRUE) %>% rownames_to_column("id")
  
  if ( is.null(estimates_all_5) ){
    estimates_all_5 = estimates_var
    } else {
      estimates_all_5 = bind_rows( estimates_var , estimates_all_5)
  }
  
  }
  
  # View(estimates_all_5)
  write_excel_csv(estimates_all_5, "~/Dropbox/_Malaria/Projects/WMR/csb_test_summary5_wmr2016.csv")
  
```

```{r}
  ## Plot test by 5 provider (3.10) 

  data = estimates_all_5 %>% filter( endyear>2013) %>% 
    rename( percent = Est. ) %>%
    mutate( provider = factor( provider, 
                                     levels = c( "Public", "CHW", "Charity", "Formal Private", "Informal Private", "No Treatment") ,
                                     labels = c( "Public health\nfacility", 
                                                 "Community health\nworker",
                                                 "Formal private\nhealth care", 
                                                "Inormal private\nhealth care", 
                                                "Inormal private health\ncare",
                                                "Not seeking care\noutside of home"))
                  )
  
  # count( data, country, startyear, endyear, survey)
  
  ylabel = "Proportion of febrile children\nreceiving a blood test"
  
  fig.3.10.5 = ggplot( data , 
        aes( provider, percent)
        ) + 
  # guides(color = guide_legend()) +
  scale_y_continuous( ylabel , label = percent, limits = c(0, 1) )  +
  scale_x_discrete("") +
  stat_boxplot(geom ='errorbar', width = .1, size = .2) + 
  geom_boxplot( fill = 'light blue', size= .2, outlier.color = 'white', width = .5) +
  theme_bw() +
  theme( axis.text = element_text(size=8) ,
         axis.title = element_text(size=8, hjust = .5, face = 'plain'),
         title  = element_text(size=9, face = 'bold', hjust = 0)) +
  ggtitle( "Figure 3.10 Proportion of febrile children tested for malaria,\nby health sector, sub-Saharan Africa, 2014-2015")
  
  fig.3.10.5
  
  # ggsave( "Figure 3.10.5categories.pdf")
  



```

## 6 levels  

```{r, include=FALSE }
 x.provider.6 = x.provider.l %>% 
    filter( endyear >= 2014 ) %>% 
    group_by( iso3c, survey, startyear, endyear, id, hv021, hv023, weight.c, h47, care_level6) %>%
    summarise( value = max( value, na.rm = TRUE ) ) %>% ungroup() %>%
    spread( care_level6, value)   # return to one record per person

  data = x.provider.6 %>% mutate( h47 = ifelse(h47 %in% 8:9, NA, h47))
 
  care_cols = c( "Public", "CHW", "Charity", "Formal Private", "Informal Private", "No Treatment") 

  estimates_all_6 = NULL
  
  for ( .var in care_cols ){
    estimates = list()
    
  for ( i in seq_along( rownames(x.list)  )){
  
    .country = x.list$country[i]
    .iso3c = countrycode( .country, "country.name", "iso3c")
    .survey = x.list$survey[i]
    .year = x.list$year[i]
    .startyear = as.integer( substr( x.list$year[i], 1, 4) )
    .endyear = as.integer(
                          ifelse( nchar(x.list$year[i])>4, 
                                paste0("20", substr( x.list$year[i], 6, 7 )), 
                                substr( x.list$year[i], 1, 4 ) )
                          )
    .survey_year =  paste(.survey, .year)
  
    cat( .country, .survey, .year, "\n") 
    
    xx = data %>% 
      filter( iso3c %in% .iso3c ,
              survey %in% .survey , 
              startyear %in% .startyear ,
             !is.na(hv021)  # survey design object, below, requires non missing value for psu (hv021)
             )  %>%
      # select_( "iso3c", "startyear", "endyear", "survey", "hv021", "weight.c", .dots = care_cols_ ) %>%
      select_( "iso3c", "startyear", "endyear",   "survey", "hv021", "hv023", "weight.c", "h47",
               .dots = c("Public", "CHW" , "Charity", "`Formal Private`", "`Informal Private`", "`No Treatment`")  ) %>%
      ungroup
    
    # if no survey, or no values, move on
    if ( nrow(xx) == 0) next 
    if ( sum(is.na( xx[, .var])) == nrow(xx) ) next 
    
    
    # Survey design object 
      
    cat( unique( with(xx, paste(iso3c, survey, startyear, .var)) ), "\n" )
      
      # test if strata exists; some surveys have no strata (e.g. madagascar mis 2011)
      has.strata.023 = nrow( as.data.frame.table( table(xx$hv023) ) ) > 1
  
      if (has.strata.023) { # urban/rural
        strataformula.c = as.formula("~hv023 ")
      } else {
          strataformula.c = NULL
      }
      
      svy.x.c  <- 
                svydesign( 
                  ~hv021  , # psu 
                  strata = strataformula.c , 
                  data =  xx, 
                  weights = ~ weight.c
                )  
    
    # survey eSTIMATES   

      if ( .var == "CHW") subset.design = subset(svy.x.c, CHW == 1 ) 
      if ( .var == "Charity") subset.design = subset(svy.x.c, Charity == 1 ) 
      if ( .var == "Public") subset.design = subset(svy.x.c, Public == 1 ) 
      if ( .var == "No Treatment") subset.design = subset(svy.x.c, `No Treatment` == 1 ) 
      if ( .var == "Formal Private") subset.design = subset(svy.x.c, `Formal Private` == 1 ) 
      if ( .var == "Informal Private") subset.design = subset(svy.x.c, `Informal Private` == 1 ) 
        
      # test is subset has values
      if ( nrow(subset.design) == 0 ) next 
      if ( sum(is.na( subset.design$variables$h47)) == nrow(subset.design) ) next 
    
     # convert svyciprop to df
      # p = svyciprop( as.formula( paste0("~`",.var, "`") ), svy.x.c, method="lo")
      p = svyciprop( ~h47, subset.design, method="lo")
      
      pp = cbind( as.numeric(p), as.data.frame( t(attributes(p)$ci) ) )
      names(pp)[1] = "Est."
      pp$var = names(p)
      cat( paste( pp, collapse = " ") , "\n")
      
      estimates[[i]] = bind_cols(  data_frame( country = .country,
                                               iso3 = .iso3c,
                                               startyear = .startyear,
                                               endyear = .endyear,
                                               survey = .survey,
                                               provider = .var
                                               ) ,
                                   pp
      )
    
    }
    
  estimates_var = rbindlist(estimates, fill = TRUE) %>% rownames_to_column("id")
  
  if ( is.null(estimates_all_6) ){
    estimates_all_6 = estimates_var
    } else {
      estimates_all_6 = bind_rows( estimates_var , estimates_all_6)
  }
  
  }
  
  # View(estimates_all_6)
  write_excel_csv(estimates_all_6, "~/Dropbox/_Malaria/Projects/WMR/csb_test_summary6_wmr2016.csv")
  
```

```{r}
  ## Plot test by 6 provider (3.10) 
  data = estimates_all_6 %>% filter( endyear>2013) %>% 
    rename( percent = Est. ) %>%
    mutate( provider = factor( provider, 
                                     levels = c( "Public", "CHW", "Charity", "Formal Private", "Informal Private", "No Treatment") ,
                                     labels = c( "Public health\nfacility", 
                                                 "Community health\nworker",
                                                 "Non-profit health\ncare", 
                                                 "Formal private\nhealth care", 
                                                "Inormal private\nhealth care",
                                                "Not seeking care\noutside of home"))
                  )
  
  # count( data, country, startyear, endyear, survey)
  
  ylabel = "Proportion of febrile children\nreceiving a blood test"
  
  fig.3.10.6 = ggplot( data , 
        aes( provider, percent)
        ) + 
  # guides(color = guide_legend()) +
  scale_y_continuous( ylabel , label = percent, limits = c(0, 1) )  +
  scale_x_discrete("") +
  stat_boxplot(geom ='errorbar', width = .1, size = .2) + 
  geom_boxplot( fill = 'light blue', size= .2, outlier.color = 'white', width = .5) +
  theme_bw() +
  theme( axis.text = element_text(size=8) ,
         axis.title = element_text(size=8, hjust = .5, face = 'plain'),
         title  = element_text(size=9, face = 'bold', hjust = 0)) +
  ggtitle( "Figure 3.10 Proportion of febrile children tested for malaria,\nby health sector, sub-Saharan Africa, 2014-2015")
  
  fig.3.10.6
  
  # ggsave( "Figure 3.10.6categories.pdf")
  
```


# Treatment


# Combined provider and test rates 
```{r}

  # 4
  grid.arrange( fig.3.9.4, fig.3.10.4, ncol=1, layout_matrix = cbind( c(1,1,2,2) ) )
  
  # 5
  grid.arrange( fig.3.9.5, fig.3.10.5, ncol=1, layout_matrix = cbind( c(1,1,2,2) ) )
  
  
 # 6
  grid.arrange( fig.3.9.6, fig.3.10.6, ncol=1, layout_matrix = cbind( c(1,1,2,2) ) )
  
  
```

# Overall testing rate

```{r, message=FALSE}
 # TOTALS   (fig 3.A)
  provider.rates = read_csv("~/Dropbox/_Malaria/Projects/WMR/csb_survey_summary5_wmr2016.csv") %>%
    rename( provider = var, csb = Est. ) %>% select( -`2.5%`, -`97.5%`)
  
  test.rates = read_csv("~/Dropbox/_Malaria/Projects/WMR/csb_test_summary5_wmr2016.csv") %>%
    rename( test = Est. ) %>% select( -`2.5%`, -`97.5%`)
  
  combined.rates = inner_join( provider.rates, test.rates)
  
  
  ylabel = "Proportion of febrile children\ntested for malaria\n"
  title = "Figure 3.A Proportion of febrile children tested for malaria, sub-Saharan Africa, 2014-2015"
    
  data = combined.rates %>% filter( endyear>2013) %>% 
    mutate( tested = csb * test ) %>%
    mutate( provider = factor( provider, 
                                     levels = c( "Public", "CHW", "Formal Private", "Informal Private", "No Treatment") ,
                                     labels = c( "Public health\nfacility", 
                                                 "Community health\nworker",
                                                 "Formal private\nhealth care", 
                                                "Inormal private\nhealth care",
                                                "Not seeking care\noutside of home"))
                  ) %>%
    group_by( country, survey ) %>%
    summarize( 
      percent.tested = sum( tested )
      )
  
  ggplot( data , aes( y = percent.tested, x = "All Porviders" ) ) + 
  scale_y_continuous( ylabel , label = percent, limits = c(0, 1) )  +
  scale_x_discrete("") +
  stat_boxplot(geom ='errorbar', width = .1, size = .2) +
  geom_boxplot(fill = 'light blue', size= .2, outlier.color = 'white', width = .5)  +
  theme_bw() +
  theme( axis.text = element_text(size=8) ,
         axis.title = element_text(size=8, hjust = .5, face = 'plain'),
         title  = element_text(size=9, face = 'bold', hjust = 0)) +
  ggtitle( title )
  
  # ggsave( "Figure 3.A.pdf")
  
```

# Overall proportion of children with fever tested by provider
  
```{r}
  
  ### 
  ylabel = "Proportion of tests for malaria\n(among febrile children)\n"
  title = "Figure 3.B Proportion of tests for malaria (among febrile children)\nby health sector, sub-Saharan Africa, 2014-2015"
  
  data = combined.rates %>% filter( endyear>2013) %>% 
    mutate( tested = csb * test ) %>%
    mutate( provider = factor( provider, 
                                     levels = c( "Public", "CHW", "Formal Private", "Informal Private", "No Treatment") ,
                                     labels = c( "Public health\nfacility", 
                                                 "Community health\nworker",
                                                 "Formal private\nhealth care", 
                                                "Inormal private\nhealth care",
                                                "Not seeking care\noutside of home"))
                  ) %>%
    group_by( country, survey ) %>%
    mutate( 
      total.tested = sum( tested )
      ) %>%
    group_by( country, survey, provider ) %>%
    mutate( 
      percent.of.tested = tested / total.tested
      )
  
  ggplot( data , 
        aes( provider, percent.of.tested)
        ) + 
  # guides(color = guide_legend()) +
  scale_y_continuous( ylabel , label = percent, limits = c(0, 1) )  +
  scale_x_discrete("") +
  stat_boxplot(geom ='errorbar', width = .1, size = .2) + 
  geom_boxplot( fill = 'light blue', size= .2, outlier.color = 'white', width = .5) +
  theme_bw() +
  theme( axis.text = element_text(size=8) ,
         axis.title = element_text(size=8, hjust = .5, face = 'plain'),
         title  = element_text(size=9, face = 'bold', hjust = 0)) +
  ggtitle( title )
  
  # ggsave( "Figure 3.B.5categories.pdf")
  
   
```

# Trends in last decade
## care-seeking
```{r, include=FALSE}

  x.provider.3b = x.provider.l %>%  
    group_by( iso3c, survey, startyear, endyear, id, hv021, hv023, weight.c, h47, care_level3b) %>%
    summarise( value = max( value, na.rm = TRUE ) ) %>% ungroup() %>%
    spread( care_level3b, value)   # return to one record per person
  
  write_excel_csv(x.provider.3b, "~/Dropbox/_Malaria/Projects/WMR/csb_survey_data_wmr2016.csv")
   
  
  data = x.provider.3b
  care_cols = c( "HMIS", "Non-HMIS", "No Treatment") 
  

  estimates_all_3b = NULL

for ( .var in care_cols ){
  estimates = list()
  
for ( i in seq_along( rownames(x.list)  )){

  .country = x.list$country[i]
  .iso3c = countrycode( .country, "country.name", "iso3c")
  .survey = x.list$survey[i]
  .year = x.list$year[i]
  .startyear = as.integer( substr( x.list$year[i], 1, 4) )
  .endyear = as.integer(
                        ifelse( nchar(x.list$year[i])>4, 
                              paste0("20", substr( x.list$year[i], 6, 7 )), 
                              substr( x.list$year[i], 1, 4 ) )
                        )
  .survey_year =  paste(.survey, .year)

  cat( .country, .survey, .year, "\n") 
  
  xx = data %>% 
    filter( iso3c %in% .iso3c ,
            survey %in% .survey , 
            startyear %in% .startyear ,
           !is.na(hv021)  # survey design object, below, requires non missing value for psu (hv021)
           )  %>%
    # select_( "iso3c", "startyear", "endyear", "survey", "hv021", "weight.c", .dots = care_cols_ ) %>%
    select_( "iso3c", "startyear", "endyear",   "survey", "hv021", "hv023", "weight.c",
             .dots =  c( "HMIS", "`Non-HMIS`", "`No Treatment`") ) 
  
  # if no survey, or no values, move on
  if ( nrow(xx) == 0) next 
  if ( sum(is.na( xx[, .var])) == nrow(xx) ) next 
  
  
  # Survey design object 
    
  unique( with(xx, paste(iso3c, survey, startyear)) )
    
    # test if strata exists; some surveys have no strata (e.g. madagascar mis 2011)
    has.strata.023 = nrow( as.data.frame.table( table(xx$hv023) ) ) > 1

    if (has.strata.023) { # urban/rural
      strataformula.c = as.formula("~hv023 ")
    } else {
        strataformula.c = NULL
    }
    
    svy.x.c  <- 
              svydesign( 
                ~hv021  , # psu 
                strata = strataformula.c , 
                data =  xx, 
                weights = ~ weight.c
              )  
  
  # survey eSTIMATES   
  
    # convert svyciprop to df
    p = svyciprop( as.formula( paste0("~`",.var, "`") ), svy.x.c, method="lo")
    pp = cbind( as.numeric(p), as.data.frame( t(attributes(p)$ci) ) )
    names(pp)[1] = "Est."
    pp$var = names(p)
    cat( paste( pp, collapse = " ") , "\n")
    
    estimates[[i]] = bind_cols(  data_frame( country = .country,
                                             iso3 = .iso3c,
                                             startyear = .startyear,
                                             endyear = .endyear,
                                             survey = .survey
                                             ) ,
                                 pp
    )
  
  }
  
estimates_var = rbindlist(estimates, fill = TRUE) %>% rownames_to_column("id")

if ( is.null(estimates_all_3b) ){
  estimates_all_3b = estimates_var
  } else {
    estimates_all_3b = bind_rows( estimates_var , estimates_all_3b)
}

}

  # View(estimates_all_3b)
  write_excel_csv(estimates_all_3b, "~/Dropbox/_Malaria/Projects/WMR/csb_survey_3b_wmr2016.csv")

  est = estimates_all_3b %>% select(-`2.5%`, -`97.5%`) %>% spread(var, Est.)
  write_excel_csv(est, "~/Dropbox/_Malaria/Projects/WMR/John3.9.3b.csv")

  # count( estimates_all_3b, endyear)
```


```{r}
## plot TREND 

  care_cols = c( "HMIS", "Non-HMIS", "No Treatment") 
  
  data = estimates_all_3b %>% 
    rename( provider = var, percent = Est. ) %>%
    mutate( provider = factor( provider, 
                                     levels = c( "HMIS", "Non-HMIS", "No Treatment") ,
                                     labels = c("Public health\nfacility", "Private\nhealth care",
                                                "Not seeking care\noutside of home"))
                  )
  
  # count( data, country, startyear, endyear, survey)
  
  # Add population < 5  for re-weighting 
  pop05 = readRDS( "../Populations/pop05_africa.RDS") %>%
    mutate( iso3 = countrycode( iso2c, "iso2c", "iso3c"))
  
  # join pop estimates
  data = data %>% as.data.frame %>% 
    inner_join(pop05[, c("iso3", "year", "pop")],
                     by = c("endyear" = "year", "iso3" = "iso3")
                     )
  
  ylabel = "Proportion of febrile children\npresenting for treatment\n"
  
  fig.3.9.trend = 
    ggplot( data , 
        aes( endyear, percent, group = provider, color = provider)
        ) + 
  # guides(color = guide_legend()) +
  scale_y_continuous( ylabel , label = percent, limits = c(0, 1) )  +
  scale_x_continuous("", breaks = 2005:2015) +
  scale_size( guide = FALSE ) +
  scale_color_brewer( type = 'qual') +
  geom_point( alpha = .5 ) + # , aes(size = pop)
  geom_smooth(se = FALSE) +
  theme_bw() +
  theme( axis.text = element_text(size=8) ,
         axis.title = element_text(size=8, hjust = .5, face = 'plain'),
         title  = element_text(size=9, face = 'bold', hjust = 0),
         legend.position = "top") +
  ggtitle( "Figure 3.IX Proportion of febrile children presenting for treatment,\nby health sector, sub-Saharan Africa, 2014-2015")
  
  fig.3.9.trend
  
  # ggsave( "Figure 3.9.trend.pdf")
  
```


## Testing rates
  
```{r, include=FALSE}
  x.provider.3b = x.provider.l %>%  
    filter( endyear >= 2006 ) %>% 
    group_by( iso3c, survey, startyear, endyear, id, hv021, hv023, weight.c, h47, care_level3b) %>%
    summarise( value = max( value, na.rm = TRUE ) ) %>% ungroup() %>%
    spread( care_level3b, value)   # return to one record per person

  data = x.provider.3b %>% mutate( h47 = ifelse(h47 %in% 8:9, NA, h47))
 
  estimates_all_3b = NULL
  
  for ( .var in care_cols ){
    estimates = list()
    
  for ( i in seq_along( rownames(x.list)  )){
  
    .country = x.list$country[i]
    .iso3c = countrycode( .country, "country.name", "iso3c")
    .survey = x.list$survey[i]
    .year = x.list$year[i]
    .startyear = as.integer( substr( x.list$year[i], 1, 4) )
    .endyear = as.integer(
                          ifelse( nchar(x.list$year[i])>4, 
                                paste0("20", substr( x.list$year[i], 6, 7 )), 
                                substr( x.list$year[i], 1, 4 ) )
                          )
    .survey_year =  paste(.survey, .year)
  
    cat( .country, .survey, .year, "\n") 
    
    xx = data %>% 
      filter( iso3c %in% .iso3c ,
              survey %in% .survey , 
              startyear %in% .startyear ,
             !is.na(hv021)  # survey design object, below, requires non missing value for psu (hv021)
             )  %>%
      select_( "iso3c", "startyear", "endyear",   "survey", "hv021", "hv023", "weight.c", "h47",
               .dots =  c( "HMIS", "`Non-HMIS`", "`No Treatment`") )  %>%
      ungroup
    
    # if no survey, or no values, move on
    if ( nrow(xx) == 0) next 
    if ( sum(is.na( xx[, .var])) == nrow(xx) ) next 
    
    
    # Survey design object 
      
    cat( unique( with(xx, paste(iso3c, survey, startyear, .var)) ), "\n" )
      
      # test if strata exists; some surveys have no strata (e.g. madagascar mis 2011)
      has.strata.023 = nrow( as.data.frame.table( table(xx$hv023) ) ) > 1
  
      if (has.strata.023) { # urban/rural
        strataformula.c = as.formula("~hv023 ")
      } else {
          strataformula.c = NULL
      }
      
      svy.x.c  <- 
                svydesign( 
                  ~hv021  , # psu 
                  strata = strataformula.c , 
                  data =  xx, 
                  weights = ~ weight.c
                )  
    
    # survey eSTIMATES   

      if ( .var == "HMIS") subset.design = subset(svy.x.c, HMIS == 1 ) 
      if ( .var == "No Treatment") subset.design = subset(svy.x.c, `No Treatment` == 1 ) 
      if ( .var == "Non-HMIS") subset.design = subset(svy.x.c, `Non-HMIS` == 1 ) 
        
      # test is subset has values
      if ( nrow(subset.design) == 0 ) next 
      if ( sum(is.na( subset.design$variables$h47)) == nrow(subset.design) ) next 
    
     # convert svyciprop to df
      # p = svyciprop( as.formula( paste0("~`",.var, "`") ), svy.x.c, method="lo")
      p = svyciprop( ~h47, subset.design, method="lo")
      
      pp = cbind( as.numeric(p), as.data.frame( t(attributes(p)$ci) ) )
      names(pp)[1] = "Est."
      pp$var = names(p)
      cat( paste( pp, collapse = " ") , "\n")
      
      estimates[[i]] = bind_cols(  data_frame( country = .country,
                                               iso3 = .iso3c,
                                               startyear = .startyear,
                                               endyear = .endyear,
                                               survey = .survey,
                                               provider = .var
                                               ) ,
                                   pp
      )
    
    }
    
  estimates_var = rbindlist(estimates, fill = TRUE) %>% rownames_to_column("id")
  
  if ( is.null(estimates_all_3b) ){
    estimates_all_3b = estimates_var
    } else {
      estimates_all_3b = bind_rows( estimates_var , estimates_all_3b)
  }
  
  }
  
  care_cols = c( "HMIS", "Non-HMIS", "No Treatment") 
  
  data = estimates_all_3b %>% 
    rename( percent = Est. ) %>%
    mutate( provider = factor( provider, 
                                     levels = c( "HMIS", "Non-HMIS", "No Treatment") ,
                                     labels = c("Public health\nfacility", "Private health\ncare",
                                                "Not seeking care\noutside of home")),
            endyear = factor( endyear, levels = 2006:2015)
                  )
  
  # count( data, country, startyear, endyear, survey)
  
  # Add population < 5  for re-weighting 
  pop05 = readRDS( "../Populations/pop05_africa.RDS") %>%
    mutate( iso3 = countrycode( iso2c, "iso2c", "iso3c"))
  
  # join pop estimates
  # data = data %>% as.data.frame %>% 
  #   inner_join(pop05[, c("iso3", "year", "pop")],
  #                    by = c("endyear" = "year", "iso3" = "iso3")
  #                    )
  
```

```{r}
  ylabel = "Proportion of febrile children\npresenting for treatment\n"
  
  fig.3.10.trend = 
    ggplot( data , 
        aes( endyear, percent, group = provider, color = provider)
        ) + 
  # guides(color = guide_legend()) +
  scale_y_continuous( ylabel , label = percent, limits = c(0, 1) )  +
  scale_x_discrete("", drop = FALSE) +
  scale_size( guide = FALSE ) +
  scale_color_brewer( type = 'qual', guide = FALSE) +
  geom_point( alpha = .5 ) + # , aes(size = pop)
  geom_smooth(se = FALSE) +
  theme_bw() +
  theme( axis.text = element_text(size=8) ,
         axis.title = element_text(size=8, hjust = .5, face = 'plain'),
         title  = element_text(size=9, face = 'bold', hjust = 0)) +
  ggtitle( "Figure 3.X Proportion of febrile children tested for malaria,\nby health sector, sub-Saharan Africa, 2014-2015")
  
  fig.3.10.trend
  
  # ggsave( "Figure 3.10.trend.pdf")
  
  grid.arrange( fig.3.9.trend, fig.3.10.trend, ncol=1, layout_matrix = cbind( c(1,1,1,1,2,2,2) ) )
  # ggsave( "Figure 3.9.and.10.trend.pdf")
  
```

