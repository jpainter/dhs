---
title: "DHS Datasets"
author: "jp"
date: "10/5/2016"
output:
  html_notebook: default
  pdf_document: default
---

```{r, include= FALSE}

library(knitr)
library(scales, quietly = TRUE)
library(data.table)
library(dtplyr)
library(tidyverse, quietly = TRUE)
library(countrycode)

opts_chunk$set( echo = TRUE, cache = TRUE )


```

# Select country/surveys to include 

```{r}

source("file_list.r")

subsahara = countrycode_data %>%
  filter( region %in% c("Middle Africa", "Western Africa", "Eastern Africa", "Southern Africa")) %>% 
  select( country.name, iso3c ) 


files = files %>% 
  mutate( country.name = countrycode(country, "country.name", "country.name")) %>%
  filter( survey!="", year >= 2000 , country.name %in% subsahara$country.name)

# View(files)

# not_needed = c('Bangladesh', 'Pakistan', 'Philippines', 'Comoros')

survey_list = files %>% count(country, survey, year) %>% select(-n)
# View(survey_list)

nsurveys = nrow(survey_list)
ncountries = length( unique( files$country ) )

cat( "There are", nsurveys, "surveys since 2000 from",  ncountries ,"countries.")

# kable( survey_list )
```


# Select variables of interest for bednet study

```{r}

dd <-readRDS("dictionary.rds")   # about 6 sec
  
bednet_effect_vars  = c( 
        'hml32', 'hml35', 
        'hml1', 'hml19', 'hml20', 
        "hv012", 
        "hv001", "hv025"
       )
  
variables <- unique( toupper( bednet_effect_vars) )
variables = variables[ order(variables) ]

major_file_types = c( "Children's Recode", "Household Member Recode", "Household Recode", "Individual Recode", "Supplemental Births Recode", "Supplemental Household Recode" )


# list variables and variable names
lv = dd %>%
  filter( survey != "", year >= 2000 , country_name %in% subsahara$country.name) %>%
  filter( Item_Name %in% variables ) %>% # comment this line out to get full list of variables
  filter( !grepl( "NA", Item_Label, ignore.case = FALSE, fixed = TRUE) ,
          file %in% major_file_types ) %>%
  count( Item_Name, Item_Label, country, survey, year, file ) %>%
  select( -n ) %>% 
  group_by( Item_Name, Item_Label, file ) %>%
  summarise( n = n() ) %>%
  filter( n > 5 ) %>%
  spread( file, n )

# View(lv)

lv[is.na(lv)] <- " "  # replace NA with emptly string

kable(lv, row.names = FALSE)
```


# create dataset. run one time after updating variables or adding surveys

```{r, include=FALSE}
source("dhs_load_survey.R")

nsurveys = nrow(survey_list)
index = row.names(survey_list)
p <- progress_estimated(nsurveys)

x <- vector("list", length( nsurveys)) 

translate = FALSE  # optional translation of values to label.  
  # NB: Does not work well for all variables

for (i in seq_along( index ) ){
  
   p$pause(0.1)$tick()$print()
  
  .country = survey_list[i, ]$country
  .iso3c = countrycode( survey_list[i, ]$country, "country.name", "iso3c")
  .survey = survey_list[i, ]$survey
  .year = survey_list[i, ]$year
  .survey_year = paste(.survey, .year)

  print( paste(.country, .survey, .year))
  
  svy <- try( silent = TRUE,
    load_survey_object( 
                        # printout = TRUE ,  # un comment when testing
                        vars = variables, 
                        .country = .country, 
                        .survey = .survey,
                        .year = .year)
  )
  
  #TODO FILTER RECORDS--apply filter, like keeping only children with parasitemia, is not unnecessarily large

  if ( class(svy) == "try-error" ){ 
    next()
    }

  # returns: svy.h, svy.c, svy.w, svy.hm, vars_x, x
  # svy.h <- svy[[1]]
  # svy.c <- svy[[2]]
  # svy.w <- svy[[3]]
  # svy.hm <- svy[[4]]
  has_vars = svy[[5]]
  x[[i]] = svy[[6]] 
  
  x[[i]]$country = rep( .country, nrow(x[[i]]) )
  x[[i]]$iso3c = rep( .iso3c, nrow(x[[i]]) )
  x[[i]]$year = rep( .year, nrow(x[[i]]) )
  x[[i]]$survey = rep( .survey, nrow(x[[i]]) )

  # TODO: optional- relate dictionary to survey 

  # refine dictionary for this country-survey 
  dict = dd %>% filter_( ~country == .country , ~survey == .survey, ~year == .year,
                        ~Item_Name %in% toupper(names(has_vars))
                        )

  # # TODO: only for columns with >4 values (others easier to keep as numeric)
  # # Deriving this table should happen once, before loop
  # v = dd %>% filter( tolower(Item_Name) %in% variables) %>% group_by( Item_Name, label ) %>% 
  #   summarise( n = n()) %>% group_by( Item_Name) %>% count(Item_Name) %>% filter(nn>4) 

  if (translate){
  y = x[[i]]
  
    for (col in 1:length(colnames(y))){
      column = tolower( colnames(y)[col] )
      
      dict_var = dict %>% 
        mutate( item_name = tolower(Item_Name)) %>%
        filter_( ~item_name == column ) %>% # , ~file == "Household Member Recode"
        count( value, label) %>% select(-n)
      
      old_value = y[, col]
      new_value = dict_var[ match( old_value, dict_var$value ), ]$label
      y[, col] = ifelse( is.na( new_value), old_value, new_value)
    }
      x[[i]] = y
}

  # if (is.null(X) ){ X <- x; next()}
  # X = rbindlist( list(X, x), use.names = TRUE, fill = TRUE)
  
}
  
# X = dplyr:: bind_rows( x )  # will throw error is column types dont match 
X = rbindlist(x, fill = TRUE) %>% rownames_to_column("id")


saveRDS(X, "bednet.rds")

```

```{r}

X = readRDS(  "bednet.rds" )

data_ncountries = length( unique(X$country))
data_nsurveys = nrow( unique( as.data.frame(X)[, c("country", "survey", "year")] )  )
nvars = ncol(X)
rows = nrow(X)

cat( "The file includes", data_nsurveys, "surveys from", data_ncountries, "countries with", nvars, "columns, ", rows, "rows and is " , comma(object.size(X)[1]), "bytes")

# list surveys included
kable( X %>% tally( country, survey, year ) )
```

# create sqlite db from X: run one time after updating or adding surveys

```{r, eval=FALSE}

library(DBI)
# devtools::install_github("rstudio/pool")
library(pool)

X_db <- src_sqlite("bednet.sqlite3", create = T)
xsql <- copy_to(X_db, X, temporary = FALSE, indexes = list(c("country", "year", "survey"), "hv001", "hv00"))

```


# filter to chldren with either RDT or microscopy result
```{r}
x = X %>% filter( hml32 %in% 0:1 | hml35 %in% 0:1 )
saveRDS( x, "bednet_subset.rds")

data_ncountries = length( unique(x$country))
data_nsurveys = nrow( unique( as.data.frame(x)[, c("country", "survey", "year")] )  )
nvars = ncol(x)
rows = nrow(x)

cat( "Subsetting yields", data_nsurveys, "surveys from", data_ncountries, "countries with", nvars, "columns, ", rows, "rows and is " , comma(object.size(x)[1]), "bytes")
```



# Load last dataset created

```{r }

# full dataset

    # library(DBI)
    # # devtools::install_github("rstudio/pool")
    # library(pool)
    # 
    # pool <- dbPool(
    #   drv = "SQLite",
    #   dbname = "bednet.sqlite3"
    # )
    # 
    # namesX = dbListFields(pool, "X")
    # 
    # dbListTables(pool)
    # 
    # dbListFields(pool, "X")
    # 
    # # dbGetQuery(pool, "SELECT * from X LIMIT 5;")  # these two lines do same thing
    # 
    # src_pool(pool) %>% tbl("X") %>% head()
    

# subset:

x = readRDS( "bednet_subset.rds")

```


# See which surveys are included

```{r}
x %>% count( country, survey, year ) %>% kable( row.names = TRUE)
```




# Visualize parasitemia versus bednet coverage by cluster

```{r}
 d = x %>% 
  mutate( parasitemia = ifelse( hml32 %in% 1 | hml35 %in% 1, 1, ifelse( hml32 %in% 0 | hml35 %in% 0, 0, NA) )
          ) %>%
  group_by( country, survey, year, hv001) %>%
  summarise(
    parasitemia = sum( parasitemia %in% 1 ) / sum( parasitemia %in% 0:1 ),
    slept_under_net = sum( hml19 %in% 1 ) / sum( hml19 %in% 0:1 ),
    net_per_person = sum( hml1, na.rm  = TRUE ) / sum( hv012, na.rm  = TRUE ),
    parasitemia_net = sum( parasitemia %in% 1 & hml19 %in% 1 ) / 
      sum( parasitemia %in% 0:1 & hml19 %in% 1),
    parasitemia_no_net = sum( parasitemia %in% 1 & hml19 %in% 0 ) / 
      sum( parasitemia %in% 0:1 & hml19 %in% 0),
    n = n()
  )

ggplot( d, aes( x = slept_under_net, y = parasitemia)) +
  geom_point() +
  geom_smooth()

```

# Visualize parasitemia versus bednet coverage as Number of Nets per person 

```{r}

ggplot( d %>% filter( net_per_person<=1 ), aes( x = net_per_person, y = parasitemia)) +
  geom_point() +
  geom_smooth()
```

#  Group results for those using bednets, those not using bednet 'last night'

```{r}

d. = d %>% ungroup %>% 
  select( slept_under_net, parasitemia_net , parasitemia_no_net) %>%
  gather(cohort, val, -slept_under_net  )

ggplot( d., aes( x = slept_under_net, y = val, color = cohort, group = cohort)) +
  geom_point() +
  geom_smooth()

```


```{r}

d. = d %>% ungroup %>% 
  filter( net_per_person<=1 ) %>%
  select( net_per_person, parasitemia_net , parasitemia_no_net) %>%
  gather(cohort, val, -net_per_person  )

ggplot( d. , aes( x = net_per_person, y = val, color = cohort, group = cohort)) +
  geom_point() +
  geom_smooth()
```

# Same analysis by HOUSEHOLD, rather than PSU

```{r}
 d = x %>% 
  mutate( 
    
    parasitemia = ifelse( hml32 %in% 1 | hml35 %in% 1, 1, ifelse( hml32 %in% 0 | hml35 %in% 0, 0, NA) ),
    
    know_parasitemia = parasitemia %in% 0:1 ,
    
    know_net_use =  hml19 %in% 0:1 | hml20 %in% 0:1 ,
    
    used_net = hml19 %in% 1 | hml20 %in% 1
    
          ) %>%
  
  group_by( country, survey, year, hv001, hv002) %>%
  
  summarise(
    
    pfpr = sum( parasitemia, na.rm = TRUE ) / sum( know_parasitemia, na.rm = TRUE ),
    
    slept_under_net = sum( used_net, na.rm = TRUE ) / sum( know_net_use, na.rm = TRUE ),
    
    net_per_person = sum( hml1, na.rm  = TRUE ) / sum( hv012, na.rm  = TRUE ),
    
    pfpr_net = sum( parasitemia & used_net, na.rm = TRUE ) / sum( know_parasitemia & used_net, na.rm = TRUE ),
    
    pfpr_no_net = sum( parasitemia & !used_net, na.rm = TRUE ) / sum( know_parasitemia & !used_net, na.rm = TRUE ),
    
    n = n(),
    n_para = sum( know_parasitemia, na.rm = TRUE ),
    n_net_para = sum( know_parasitemia & used_net, na.rm = TRUE ) ,
    n_no_net = sum( know_parasitemia & !used_net, na.rm = TRUE )
  ) 

ggplot( d, aes( x = slept_under_net, y = pfpr)) +
  geom_point() +
  geom_smooth() 

```



```{r}

ggplot( d %>% filter( net_per_person<=1 ), aes( x = net_per_person, y = pfpr)) +
  geom_point() +
  geom_smooth() 
```

```{r}
d. = d %>% 
  filter( complete.cases(pfpr_net , pfpr_no_net)) %>%
  ungroup %>% 
  select( slept_under_net, pfpr_net , pfpr_no_net) %>%
  gather(cohort, val, -slept_under_net  )

ggplot( d., aes( x = slept_under_net, y = val, color = cohort, group = cohort)) +
  geom_point() +
  geom_smooth( ) + 
  scale_y_continuous("PfPR", limits = c(0,1)) 
```

```{r}
gather_cols = c( "pfpr_net" , "pfpr_no_net")

d. = d %>% ungroup %>% 
  filter( complete.cases(pfpr_net , pfpr_no_net)) %>%
  filter( net_per_person<=1 ) %>%
  gather_("cohort", "val" , gather_cols ) %>%
  arrange( country, survey, year, hv001, hv002 )

ggplot( d. , aes( x = net_per_person, y = val, color = cohort, group = cohort)) +
  geom_point() +
  scale_y_continuous("PfPR", limits = c(0,1))  +
  geom_smooth() 


```



```{r, warning=FALSE, message= FALSE}

d. = d %>%  
  filter( complete.cases(pfpr_net , pfpr_no_net)) %>%
  filter( net_per_person<=1 ) %>%
  select( country, net_per_person, pfpr_net , pfpr_no_net) %>%
  ungroup() %>%
  gather(cohort, val, -net_per_person, -country  )

ggplot( d. , aes( x = net_per_person, y = val, color = cohort, group = cohort)) +
  geom_point() +
  geom_smooth() +
  scale_y_continuous("PfPR", limits = c(0,1))  +
  facet_wrap( ~country)
```

# Are results confounded by malaria prevalence?
## Separte analysis by prevalence among those not using nets.


```{r, warning=FALSE, message=FALSE}

d. = d %>% 
  filter( net_per_person<=1 ) %>%
  mutate( prevalence = cut( parasitemia_no_net, 4) ) %>% 
  ungroup %>% 
  gather(cohort, val, -net_per_person, -country , -survey, -year, -hv001, -hv002, -prevalence )

ggplot( d. , aes( x = net_per_person, y = val, color = cohort, group = cohort)) +
  geom_point(alpha = .5) +
  geom_smooth() +
  scale_y_continuous("Parasitemia", limits = c(0,1)) +
  facet_wrap( ~ prevalence)
```

Yes--there is some interaction/co-variance, in part because the samples are paired, but the analysis is not.  For a given level on x-axis, there may be only groups from high prevalence areas that all use nets, so there is no no-net group, that get compared with groups from low-prevalence areas where there are none in the use-net group.  So, the loess line is comparing groups using nets in high prevalence areas to groups not using nets in low prevalence areas; both groups may have roughly same level of risk, therefore it looks as if the nets are not protective.

Possible solutions:  
1. make sure that each cluster has a parasitemia rate for no-net and net group (filter on complete.cases() )


```{r, warning=FALSE, message=FALSE}

d. = d %>% 
  filter( net_per_person<=1, complete.cases(parasitemia_net, parasitemia_no_net) ) %>%
  mutate( prevalence = cut( parasitemia_no_net, 4) ) %>% 
  ungroup %>% 
  select( country, net_per_person, parasitemia_net , parasitemia_no_net, prevalence) %>%
  gather(cohort, val, -net_per_person, -country , -prevalence )

ggplot( d. , aes( x = net_per_person, y = val, color = cohort, group = cohort)) +
  geom_point(alpha = .5) +
  geom_smooth() +
  scale_y_continuous("Parasitemia", limits = c(0,1)) +
  facet_wrap( ~ prevalence)
```