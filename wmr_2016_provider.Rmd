---
title: "WMR 2016 Access to care"
author: "jp"
date: "9/22/2016"
output:
  word_document:
    toc: yes
  html_document:
    toc: yes
---

```{r, include= FALSE}

library(knitr)
library(scales, quietly = TRUE)
library(data.table)
library(dtplyr)
library(tidyverse, quietly = TRUE)
library(countrycode)
library(survey)

opts_chunk$set( echo = FALSE, cache = TRUE, 
                fig.width=7.5, fig.height = 5)


```

All available surveys from Sub-Saharan Africa from 2010 to present were downloaded from DHS.  

```{r, fig.width=7.5, out.width=7.5}

source("file_list.r")

subsahara = countrycode_data %>%
  filter( region %in% c("Middle Africa", "Western Africa", "Eastern Africa", "Southern Africa")) %>% 
  select( country.name, iso3c ) %>%
  filter( !country.name %in% "Lesotho")


files = files %>% 
  mutate( country.name = countrycode(country, "country.name", "country.name")) %>%
  filter( survey!="", year >= 2000 , country.name %in% subsahara$country.name)

# not_needed = c('Bangladesh', 'Pakistan', 'Philippines', 'Comoros')

survey_list = files %>% count(country, survey, year) %>% select(-n)

nsurveys = nrow(survey_list)
ncountries = length( unique( files$country ) )

```

# `r nsurveys` surveys since 2000 from `r ncountries` countries (as of winter 2016)

# Select variables of interest  for access to care 

## broad variable labels
```{r}

dd <-readRDS("dictionary.rds")  # about 6 sec

source('dhs_variable_selection.R')

# list variables and variable names
# lv = dd %>% mutate( item_name = tolower(Item_Name) ) %>% 
#   filter( item_name %in% some_variables() ) %>% # comment this line out to get full list of variables
#   filter( !grepl( "NA", Item_Label, fixed = TRUE) ) %>%
#   group_by( item_name ) %>%
#   count( Item_Label ) %>%
#   arrange( -n ) %>%
#   summarise( item_label = first( Item_Label ) ) %>% 
#     arrange( item_name )

# View(lv)

# select variables for this analysis, v
variables =  c('v000', 
       'v001', 'v002', 'v003', 'v005', 'v021', 'v023', 'v024', 'v025', 
       'weight.c', 'weight.hm', 'weight.w', 'weight.h', 
       'hv001',  'hv002', 'hv003',  'hv005', 'hv007', 'hv021', 'hv022', 'hv023', 'hv024', 'hv025',
       'hvidx', 'b16',
       'h22', 'hv105', 'h47', 
       'hml16', # age in years
       'hml32', 'hml35',
      'h32a', 'h32b', 'h32c', 'h32d', 'h32e', 'h32f', 'h32g', 'h32h', 'h32i', 'h32s', #public/govt
      'h32j', 'h32k', 'h32l', 'h32m', 'h32n', 'h32o', 'h32p', 'h32q', 'h32r', #private
      'h32t', 'h32u', 'h32v', 'h32w', 'h32x', # informal privage/other
      'h32y', # no medical rx
      'h32z' # medical rx.  what's that mean?
      )

lv = dd %>% mutate( item_name = tolower(Item_Name) ) %>% 
  filter( item_name %in% variables ) %>% # comment this line out to get full list of variables
  filter( !grepl( "NA", Item_Label, fixed = TRUE) ) %>%
  group_by( item_name ) %>%
  count( Item_Label ) %>%
  arrange( -n ) %>%
  summarise( item_label = first( Item_Label ) ) %>% 
  arrange( item_name )

kable(lv, row.names = FALSE)
```


## survey specific variable labels

```{r}

clv = dd %>% 
  filter( year > 2011 ) %>%
  mutate( item_name = tolower(Item_Name),
                     svy = paste( country, survey, year)
                     ) %>%
  filter( grepl( "H32", Item_Name )  ) %>%
  filter( !grepl( "NA", Item_Label, fixed = TRUE) & 
            !grepl( "Note:", Item_Name, fixed = TRUE) ) %>%
  filter( file %in% "Children's Recode" ) %>% 
  count(Item_Name, Item_Label, svy, year ) %>%
  spread( Item_Name, Item_Label ) %>%
  arrange(desc( year)  )


```


# create dataset. run one time after updating variables or adding surveys

```{r, include = FALSE, eval= FALSE}
source("dhs_load_survey.R")

nsurveys = nrow(survey_list)

survey_list = survey_list %>% arrange( desc(year) )
index = row.names(survey_list)

p <- progress_estimated(nsurveys)

x <- vector("list", length( nsurveys)) 

translate = FALSE  # optional translation of values to label.  
  # NB: Does not work well for all variables

for (i in seq_along( index ) ){
  
   p$pause(0.1)$tick()$print()
  
  .country = survey_list[i, ]$country
  .iso3c = countrycode( survey_list[i, ]$country, "country.name", "iso3c")
  .survey = survey_list[i, ]$survey
  .year = survey_list[i, ]$year
  .survey_year = paste(.survey, .year)

  print( paste(.country, .survey, .year))
  
  svy <- try( silent = TRUE,
    load_survey_object( 
                        # printout = TRUE ,  # un comment when testing
                        vars = variables, 
                        .country = .country, 
                        .survey = .survey,
                        .year = .year)
  )
  
  #TODO FILTER RECORDS--apply filter, like keeping only children with parasitemia, is not unnecessarily large

  if ( class(svy) == "try-error" ){ 
    next()
    }

  # returns: svy.h, svy.c, svy.w, svy.hm, vars_x, x
  # svy.h <- svy[[1]]
  # svy.c <- svy[[2]]
  # svy.w <- svy[[3]]
  # svy.hm <- svy[[4]]
  has_vars = svy[[5]]
  x[[i]] = svy[[6]] 
  
  x[[i]]$country = rep( .country, nrow(x[[i]]) )
  x[[i]]$iso3c = rep( .iso3c, nrow(x[[i]]) )
  x[[i]]$year = rep( .year, nrow(x[[i]]) )
  x[[i]]$survey = rep( .survey, nrow(x[[i]]) )

  # TODO: optional- relate dictionary to survey 

  # refine dictionary for this country-survey 
  dict = dd %>% filter_( ~country == .country , ~survey == .survey, ~year == .year,
                        ~Item_Name %in% toupper(names(has_vars))
                        )

  # # TODO: only for columns with >4 values (others easier to keep as numeric)
  # # Deriving this table should happen once, before loop
  # v = dd %>% filter( tolower(Item_Name) %in% variables) %>% group_by( Item_Name, label ) %>% 
  #   summarise( n = n()) %>% group_by( Item_Name) %>% count(Item_Name) %>% filter(nn>4) 

  if (translate){
  y = x[[i]]
  
    for (col in 1:length(colnames(y))){
      column = tolower( colnames(y)[col] )
      
      dict_var = dict %>% 
        mutate( item_name = tolower(Item_Name)) %>%
        filter_( ~item_name == column ) %>% # , ~file == "Household Member Recode"
        count( value, label) %>% select(-n)
      
      old_value = y[, col]
      new_value = dict_var[ match( old_value, dict_var$value ), ]$label
      y[, col] = ifelse( is.na( new_value), old_value, new_value)
    }
      x[[i]] = y
}

  # if (is.null(X) ){ X <- x; next()}
  # X = rbindlist( list(X, x), use.names = TRUE, fill = TRUE)
  
}
  
# X = dplyr:: bind_rows( x )  # will throw error is column types dont match 
X = rbindlist(x, fill = TRUE) %>% rownames_to_column("id")


saveRDS(X, "provider.rds")

```

```{r, eval = TRUE, include= FALSE}

X = readRDS(  "provider.rds" )

data_ncountries = length( unique(X$country))
data_nsurveys = nrow( unique( as.data.frame(X)[, c("country", "survey", "year")] )  )
nvars = ncol(X)
rows = nrow(X)

cat( "The file includes", data_nsurveys, "surveys from", data_ncountries, "countries with", nvars, "columns, ", rows, "rows and is " , comma(object.size(X)[1]), "bytes")

# list surveys included
kable( X %>% count( country, survey, year ) %>% arrange( desc(year)) , row.names = TRUE)
```

# filter to those with fever in last 2 weeks

```{r }
# X %>% count(h22) # had fever
# X %>% filter( h22 %in% 0:1) %>% count(hml16) # age in yrs

x = X %>% filter( h22 == 1 , iso3c %in% subsahara$iso3c)

# saveRDS( x, "provider_subset.rds")

data_ncountries = length( unique(x$country))
data_nsurveys = nrow( unique( as.data.frame(x)[, c("country", "survey", "year")] )  )
nvars = ncol(x)
rows = nrow(x)

cat( "Subsetting yields", data_nsurveys, "surveys from", data_ncountries, "countries with", nvars, "columns, ", rows, "rows and is " , comma(object.size(x)[1]), "bytes")

```


# See which surveys are included

```{r}

# x = readRDS("provider_subset.rds")

x  %>% count( country, survey, year ) %>% arrange( desc(year) ) %>%  kable( row.names = TRUE)
```

# inspect data for unwanted values (e.g. 9 for missing)

```{r}

# TODO: this is slow; try to do with data.table
# inspect  = lapply( namesX[provider_cols],  function(x) X %>% count_(x) )
# 
# for (i in  seq_along(provider_cols) ){
#   
#   print( inspect[i] )
# }       

```


# define provider types

```{r}
data_names = names(x)

# 'h32a', 'h32b', 'h32c', 'h32d', 'h32e', 'h32f', 'h32g', 'h32h', 'h32i', 'h32s', #public/govt
# 'h32j', 'h32k', 'h32l', 'h32m', 'h32n', 'h32o', 'h32p', 'h32q', 'h32r', #private
# 'h32t', 'h32u', 'h32v', 'h32w', 'h32x', # informal privage/other
# 'h32y', # no medical rx
# 'h32z' # medical rx.  what's that mean?

provider_public <- which( data_names %in%  c('h32a', 'h32b', 'h32c', 'h32d', 'h32e', 'h32f', 'h32g', 'h32h', 'h32i', 'h32s') )

provider_private <- which( data_names %in%  c('h32j', 'h32k', 'h32l', 'h32m', 'h32n', 'h32o', 'h32p', 'h32q', 'h32r') )

provider_other <- which( data_names %in%  c('h32t', 'h32u', 'h32v', 'h32w', 'h32x') )

provider_none <- which( data_names %in%  c('h32y') )

provider_any <- which( data_names %in%  c('h32z') )

is1 = function(x) x %in% 1
is01 = function(x) x %in% 0:1

```

```{r}

# in memory version with data.table
# Sys.time()

x = x[ , provider_public1 := rowSums( sapply(.SD, is1) ) >0, .SDcols = colnames(x)[provider_public] ]
x = x[ , provider_public01 := rowSums( sapply(.SD, is01) ) >0, .SDcols = colnames(x)[provider_public] ]
x = x[ , provider_public := ifelse( provider_public1 == TRUE, TRUE ,
                                    ifelse( provider_public01 == TRUE, FALSE, NA)) ]

x = x[ , provider_private1 := rowSums( sapply(.SD, is1)  )>0, .SDcols = colnames(x)[provider_private] ]
x = x[ , provider_private01 := rowSums( sapply(.SD, is01)  )>0, .SDcols = colnames(x)[provider_private] ]
x = x[ , provider_private := ifelse( provider_private1 == TRUE, TRUE ,
                                    ifelse( provider_private01 == TRUE, FALSE, NA)) ]

x = x[ , provider_other1 := rowSums( sapply(.SD, is1)  )>0, .SDcols = colnames(x)[provider_other] ]
x = x[ , provider_other01 := rowSums( sapply(.SD, is01)  )>0, .SDcols = colnames(x)[provider_other] ]
x = x[ , provider_other := ifelse( provider_other1 == TRUE, TRUE ,
                                    ifelse( provider_other01 == TRUE, FALSE, NA)) ]

# Sys.time() # approx 1 hr. with full dataset, bu only 6 sec with subset  Ouch! without sapply, a couple of minutes. 


x = x[ , provider_none :=  ifelse(h32y == 1, TRUE, ifelse( h32y == 0, FALSE, NA) )]

# x = x[ , provider := ifelse(h32z == 1, TRUE, ifelse( h32z == 0, FALSE, NA) ) ]

x = x %>% select( -provider_public1, -provider_public01, -provider_private1,
                  -provider_private01, -provider_other1, -provider_other01)

```

# Create provider rates 

```{r}

# provider rates ####

provider_rate = function(
  provider = "Other",
  provider_cols = provider_other,
  db = x,
  namesX = data_names
  ){
  
  cols = c("country", "survey", "year",
           "hv023" , # strata
           "weight.hm", namesX[provider_cols])
  
  xx = db %>% 
    select_( .dots = cols  ) %>% collect(n=Inf) %>% 
    mutate( id = seq_along( country) ) 
  
  xxl = xx %>%
    gather(var, val, -id, -country, -survey, -year, -hv023, -weight.hm) %>%
    data.table()
  
  xx. = xxl[, .(
    Y = sum( val, na.rm = TRUE) > 0,
    YN = sum( !is.na( val) ) > 0 
    ),  by = list(country, survey, year, hv023, id) ]
  
  xx. = xx.[ data.table(xx)[, .(id, weight.hm)], on = "id"]
  
  xx.. = xx.[, .(
    provider = provider, 
    # weight reusults of individuals within strata
    Y = sum( as.numeric(Y * weight.hm), na.rm = TRUE),
    YN = sum(as.numeric(YN * weight.hm), na.rm = TRUE),
    
    # This weight need to weight strata within countries
    weight = sum( as.numeric(weight.hm), na.rm = TRUE) 
    ),
    by = list(country, survey, year, hv023) ]
  
  return(xx..)

}

other = provider_rate("other", provider_other )
private = provider_rate("private", provider_private )
public = provider_rate("public", provider_public )
none =  provider_rate("none", provider_none )
# any =  provider_rate("any", provider_any )
  
# x %>% summarize(n())
# nrow(public); nrow(private); nrow(other)

# Join  ####

provider = bind_rows( public ,private, other, none)

# provider[, percent := Y/YN ]
provider = provider %>% mutate(
  percent = ifelse( YN>0, Y / YN, NA ),
  yr = as.integer(substr(year, 1, 4)),
  iso2c = countrycode(country, "country.name", "iso2c")
)


# Add population < 5  for re-weighting ####
pop05 = readRDS( "../Populations/pop05_africa.RDS")
# str(pop05)

# join pop estimates
provider = provider %>% as.data.frame %>% 
  inner_join(pop05[, c("iso2c", "year", "pop")],
                   by = c("yr" = "year", "iso2c" = "iso2c")
                   )

#check totals...there is some issue where thery dont add to 1
# providerSummary = provider %>% 
#   group_by(country, survey, year, provider) %>%
#   summarise(
#     mean = mean(percent, na.rm = TRUE)
#     ) %>%
#   spread(provider, mean) %>%
#   mutate( total = public+private+other+none)
# 
# View(providerSummary)

```

```{r}
provider2_strata  = 
  x %>% 
  select(country, survey, year, hv023, weight.h, provider_public, provider_private, provider_other, provider_none  ) %>%
  gather_( "provider", "val", 
           c("provider_public", "provider_private", "provider_other", "provider_none")
           ) %>% 
  group_by(country, survey, year, hv023, provider) %>%
  summarise(
    val.TRUE = sum( val %in% TRUE) ,
    val.FALSE = sum( val %in% FALSE ),
    val.TOTAL = sum( val %in% c(TRUE, FALSE) )
  ) %>%
  inner_join(  # join survey weights
    x %>% 
      group_by( country, survey, year, hv023 ) %>% 
      summarise( 
        weight = sum( as.numeric( weight.h), na.rm = TRUE ) 
        )
  )

# View(provider2)

provider2_country = provider2_strata %>%
  group_by( country, survey, year, provider ) %>%
  summarise(
    provider.yes = sum( val.TRUE , na.rm = TRUE) ,
    provider.total = sum( val.TOTAL , na.rm = TRUE) ,
    provider_crude_rate = provider.yes / provider.total , 
    provider_rate = sum( val.TRUE * weight , na.rm = TRUE) /
      ( sum( weight, na.rm = TRUE) *  sum( val.TOTAL , na.rm = TRUE) )
  )

# View(provider2_country)
```


## Visualize raw data

```{r}

d = provider %>% 
  mutate( yr = as.integer( substr(year, 0 , 4)) ,
          
          # if more than 1 year in survey, use 2nd
          yr = ifelse( nchar(year)>4, yr + 1, yr)
          )  

# group by country
d =  d %>% group_by(country, survey, yr, provider) %>%
  filter( YN > 0 ) %>%
  summarise( 
    percent =   sum(Y * weight)  / sum(YN * weight ),
    pop = first(pop) 
  )



```

##  unweighted 

```{r}

ggplot( d, aes( yr, percent, color = provider, group = provider)) + 
  guides(color = guide_legend(reverse = TRUE)) +
  geom_point() +
  geom_smooth( )

```

## weighted by country population

```{r}
ggplot( d, aes( yr, percent, color = provider, group = provider)) + 
  guides(color = guide_legend(reverse = TRUE)) +
  geom_point() +
  geom_smooth( aes(weight = pop) )
```

# ggvis version

```{r, eval = FALSE}
library(ggvis)

d$id <- 1:nrow(d)

tooltip = function(data){
  if(is.null(data)) return(NULL)
  row <- d[d$id == data$id, ]
  # paste0(names(row), ": ", format(row), collapse = "<br />")
  paste( row$country, row$survey, row$year, row$yr, row$n )
}

d %>% 
  filter( complete.cases(.)) %>%
  ggvis(~yr, ~percent, stroke = ~provider, fill = ~provider)  %>% 
  layer_points( key := ~id ) %>%
  # group_by( provider ) %>%
  # layer_smooths( ) %>%
  add_tooltip( tooltip, "hover" )

```

# Provider Type among children with fever

## weighted by populations, 2014-2015 (figure 3.9)

```{r}

ggplot( d %>% filter( yr >=2014 ) %>%
          mutate( provider = factor( provider, 
                                     levels = c("public", "private", "other", "none"),
                                     labels = c("Public health\nfacility", "Private health\ncare", "Other health\ncare", "Not seeking care\noutside of home"))
                  ), 
        aes( provider, percent)
        ) + 
  # guides(color = guide_legend()) +
  scale_y_continuous("Percentage\n", label = percent )  +
  scale_x_discrete("\nProvider Type") +
  geom_boxplot( fill = 'blue', aes( weight = pop)) +
  theme_bw() +
  ggtitle( "Figure 3.9 Proportion of febrile children presenting for treatment,\nby health sector, sub-Saharan Africa, 2014-2015")
```

# blood test (figure 3.10)

```{r}
# heel/finger stick is h47

x_test = 
  x %>% 
  select(country, survey, year, hv023,weight.h, h47, provider_public, provider_private, provider_other, provider_none  ) %>%
  mutate(
    stick = ifelse(h47 %in% 1, TRUE, ifelse( h47 %in% 0:1, FALSE, NA)) 
  ) %>%
  filter( !is.na(stick) ) %>%
  gather_( "provider", "val", 
           c("provider_public", "provider_private", "provider_other", "provider_none")
           ) %>%
  filter( val == TRUE ) %>%
  group_by(country, survey, year, hv023, provider) %>%
  summarise(
    stick.TRUE = sum( stick %in% TRUE) ,
    stick.FALSE = sum( stick %in% FALSE )
  ) %>%
  mutate(
    stick.TRUE = ifelse( is.na(stick.TRUE), 0, stick.TRUE) , 
    stick.FALSE = ifelse( is.na(stick.FALSE), 0, stick.FALSE) 
  ) %>%
  inner_join(  # join survey weights
    x %>% 
      group_by( country, survey, year, hv023 ) %>% 
      summarise( 
        weight = sum( as.numeric( weight.h), na.rm = TRUE ) 
        )
  )
  
```

# unweighted, plot of blood test by provider

```{r}
ggplot( x_test %>% 
          filter( substr( year, 1, 4)  >= 2014 ) %>%
          mutate( provider = factor( provider, 
                                     levels = c("provider_public", "provider_private",
                                                "provider_other", "provider_none"),
                                     labels = c("Public health\nfacility", 
                                                "Private health\ncare", 
                                                "Other health\ncare", 
                                                "Not seeking care\noutside of home")
                                     )
          ) %>% 
          group_by( country, survey, year, provider) %>%
          summarise(
            test_rate_crude = sum(stick.TRUE, na.rm = TRUE) / 
                    ( sum(stick.TRUE) + sum(stick.FALSE) )  ,
            
            
                  test_rate = sum(stick.TRUE * weight, na.rm = TRUE) / 
                    ( ( sum(stick.TRUE) + sum(stick.FALSE) )  * sum(weight, na.rm = TRUE) ) 
                  ) %>%
          filter( !(provider %in% "Not seeking care\noutside of home") ), 
        aes( provider, test_rate_crude)
        ) + 
  # guides(color = guide_legend()) +
  scale_y_continuous("Percentage\n", label = percent )  +
  scale_x_discrete("\nProvider Type", drop = TRUE) +
  geom_boxplot( fill = 'blue') +
  theme_bw() +
  ggtitle( "Figure 3.10 Proportion of febrile children receiving a blood test,\nby health sector, sub-Saharan Africa, 2014-2015")
```


# Models

## Classical

```{r, eval=FALSE}

dm = provider %>%
  select( -public, -private, -other) %>%
  mutate( yr = as.integer( substr(year, 0 , 4))) %>% 
  select( - year ) %>%
  gather(provider, val, -country, -survey, -yr) 

m = glm( val ~ country + provider + yr,  data = dm)



```

# bayes model
```{r, eval=FALSE}
library(rethinking)

d$country_id = coerce_index( d$country)
d$provider_id = coerce_index( d$provider)

d. = d %>% select(country_id, val, yr) %>%
  filter(complete.cases(.)) %>% as.data.frame()

    m1 = map2stan(
        alist(
          val ~ dbinom( 1, p ),
          logit(p) <- a_country[country_id]  + b*yr,
          a_country[country_id] ~ dnorm( ac, sigma_c),
          ac ~ dnorm( 0, 2),
          b ~ dnorm(0, 2),
          sigma_c ~ dcauchy(0, 2),
          sigma_p ~ dcauchy(0, 2)
          
        ), data =  d., warmup = 500, iter = 4500, chains = 1)
    
    # same by map
    ## crude
    mm = map(
        alist(
          hml32 ~ dbinom( 1, p ),
          logit(p) <- a ,
          a ~ dnorm( 0, 10)
        ), data =  d)
    
    mmp = precis(mm) 
    unlist( logistic( mmp@output ) )
```

