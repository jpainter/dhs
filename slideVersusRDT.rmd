---
title: "Slide vs RDT"
runtime: shiny
output: 
  # ioslides_presentation 
  html_document:
    css: shinyprezcss.css
    fig_height: 6
    fig_width: 10
    number_sections: yes
    toc: yes
---

# A Comparison of DHS and MIS malaria parasitemia estimates by microscopy (slides) with RDT 

# Main data 

```{r,  include = FALSE}

source("file_list.r")

subsahara = countrycode_data %>%
  filter( region %in% c("Middle Africa", "Western Africa", "Eastern Africa", "Southern Africa")) %>% 
  select( country.name, iso3c ) %>%
  filter( !country.name %in% "Lesotho") 


files = files %>% 
  mutate( country.name = countrycode(country, "country.name", "country.name")) %>%
  filter( survey!="", year >= 2006 , country.name %in% subsahara$country.name)

# not_needed = c('Bangladesh', 'Pakistan', 'Philippines', 'Comoros')

survey_list = files %>% count(country, survey, year) %>% select(-n) %>% arrange(desc(year))

nsurveys = nrow(survey_list)
ncountries = length( unique( files$country ) )

kable(survey_list, row.names = TRUE)

```

```{r, include = FALSE, eval= FALSE}
# select variables for this analysis, v
variables =  c('v000', 
       'v001', 'v002', 'v003', 'v005', 'v021', 'v023', 'v024', 'v025', 
       'weight.c', 'weight.hm', 'weight.w', 'weight.h', 
       'hv001',  'hv002', 'hv003',  'hv005', 'hv007', 'hv021', 'hv022', 'hv023', 'hv024', 'hv025',
       'hvidx', 'b16',
       'h22', 'hv105', 'h47', 
       'hml16', # age in years
       'hml32', 'hml35' )

```

```{r, include = FALSE, eval= FALSE}
source("dhs_load_survey.R")

nsurveys = nrow(survey_list)

survey_list = survey_list %>% arrange( desc(year) )
index = row.names(survey_list)

p <- progress_estimated(nsurveys)

x <- vector("list", length( nsurveys)) 

translate = FALSE  # optional translation of values to label.  
  # NB: Does not work well for all variables

for (i in seq_along( index ) ){
  
   p$pause(0.1)$tick()$print()
  
  .country = survey_list[i, ]$country
  .iso3c = countrycode( survey_list[i, ]$country, "country.name", "iso3c")
  .survey = survey_list[i, ]$survey
  .year = survey_list[i, ]$year
  .survey_year = paste(.survey, .year)

  print( paste(.country, .survey, .year))
  
  svy <- try( silent = TRUE,
    load_survey_object( design = FALSE,
                        # printout = TRUE ,  # un comment when testing
                        vars = variables, 
                        .country = .country, 
                        .survey = .survey,
                        .year = .year)
  )
  
  #TODO FILTER RECORDS--apply filter, like keeping only children with parasitemia, is not unnecessarily large

  if ( class(svy) == "try-error" ){ 
    next()
    }

  # returns: svy.h, svy.c, svy.w, svy.hm, vars_x, x
  # svy.h <- svy[[1]]
  # svy.c <- svy[[2]]
  # svy.w <- svy[[3]]
  # svy.hm <- svy[[4]]
  has_vars = svy[[5]]
  x[[i]] = svy[[6]] 
  
  x[[i]]$country = rep( .country, nrow(x[[i]]) )
  x[[i]]$iso3c = rep( .iso3c, nrow(x[[i]]) )
  x[[i]]$year = rep( .year, nrow(x[[i]]) )
  x[[i]]$survey = rep( .survey, nrow(x[[i]]) )

  # TODO: optional- relate dictionary to survey                    )

  # # TODO: only for columns with >4 values (others easier to keep as numeric)
  # # Deriving this table should happen once, before loop
  # v = dd %>% filter( tolower(Item_Name) %in% variables) %>% group_by( Item_Name, label ) %>% 
  #   summarise( n = n()) %>% group_by( Item_Name) %>% count(Item_Name) %>% filter(nn>4) 

  if (translate){
    
      # refine dictionary for this country-survey 
      dict = dd %>% filter_( ~country == .country , ~survey == .survey, ~year == .year,
                        ~Item_Name %in% toupper(names(has_vars))
      )
     
    y = x[[i]]
  
    for (col in 1:length(colnames(y))){
      column = tolower( colnames(y)[col] )
      
      dict_var = dict %>% 
        mutate( item_name = tolower(Item_Name)) %>%
        filter_( ~item_name == column ) %>% # , ~file == "Household Member Recode"
        count( value, label) %>% select(-n)
      
      old_value = y[, col]
      new_value = dict_var[ match( old_value, dict_var$value ), ]$label
      y[, col] = ifelse( is.na( new_value), old_value, new_value)
    }
      x[[i]] = y
}

  # if (is.null(X) ){ X <- x; next()}
  # X = rbindlist( list(X, x), use.names = TRUE, fill = TRUE)
  
}
  
# X = dplyr:: bind_rows( x )  # will throw error is column types dont match 
X = rbindlist(x, fill = TRUE) %>% rownames_to_column("id")

saveRDS(X, "rdt_microscopy.rds")

# object.size(X)

```

```{r}
x = readRDS("rdt_microscopy.rds")
```

## subset to available surveys from 2006 to 2016: 

```{r}

subsahara = countrycode_data %>%
  filter( region %in% c("Middle Africa", "Western Africa", "Eastern Africa", "Southern Africa")) %>% 
  select( country.name, iso3c ) %>%
  filter( !country.name %in% "Lesotho") 

x = x %>% 
  mutate( startyear = as.integer( substr( year, 1, 4 ) ),
            endyear = as.integer(
              ifelse( nchar(year)>4, 
                              paste0("20", substr( year, 6, 7 )), 
                              substr( year, 1, 4 ))
            )
            ) %>%
  filter( 
          # endyear >= 2006, 
          # iso3c %in% subsahara$iso3c ,
          !is.na(weight.c) ,  # only those with weight 
          !is.na(hml32) , 
          !is.na(hml35)
          ) %>% 
  as.data.table()

x.list = x %>% count( country, survey, year ) %>% arrange(desc(year) )

kable( x.list %>% select(-n) , row.names = TRUE)


```

## data dictionary

```{r, message=FALSE, warning=FALSE, include = FALSE}
# get dictionary vales from children's file

  # dd <-readRDS("dictionaryNew.rds")  # about 6 sec

#Which files have treatment variables h37 and ml13?  both in children's file
# count( filter(dd, grepl( "H37|ML13", Item_Name )), file)

  dd = readRDS("dictionaryNew.rds")  %>% ungroup %>%
    filter( Item_Name %in% toupper(variables),
            country %in% x$country,
            survey %in% x$survey,
            year %in% x$year
            ) %>%
    mutate(
      startyear = as.integer( substr( year, 1, 4 ) ) ,
      endyear = as.integer(
              ifelse( nchar(year)>4, 
                              paste0("20", substr( year, 6, 7 )), 
                              substr( year, 1, 4 ))
            ),
      Item_Label = tolower( Item_Label ) ,
      Item_Name = tolower( Item_Name)
    ) %>%
    filter( endyear >= 2006 ) 
  
  View(dd)

```


```{r,  echo = FALSE, eval=FALSE}

# run this one time to get data set

source("file_list.r")  

source("getSurveyValue.R")

library(survey)

  # percent forumula that respects zero
  my.percent<- function(x) {
    if(length(x)==1) if(x==0) return(paste0(0,"%") )
    return(percent(x) )
  }
  
# fetch each survey and keep data from those that have malaria test data
rdt_slide_table = function(s){ 
  # assign variable to data and to design
  x = s$data
  svy = s$design

  # select key fields
  slide.rdt = 
    x %>% 
    # select( hhid, hvidx, hv005, hv021, hv023, hv024, hml32, hml35 ) %>% 
    rename( 
            psu = hv021,
            strata = hv023
            # ,
#             region = hv024,
#             slide = hml32,
#             rdt = hml35,
#             pf = hml32a,
#             pm = hml32b,
#             po = hml32c,
#             pv = hml32d
            )  %>%
    mutate( 
            weight = as.numeric( hv005 ),
            pf = sum(pf==1),
            notpf = sum(pm==0:1, po==0:1, pv==0:1)
            )
  
  nrow(slide.rdt)
 
# filter complete slide and rdt 
  has.slide = sum(x$hml32 %in% 0:1) > 0
  has.rdt = sum(x$hml35 %in% 0:1) > 0
  
  if ( !(has.slide && has.rdt) ){
    stop("slide and/or rdt values are all missing")
  }
  
  # remove rows with no test  
#   slide.rdt = slide.rdt[has.data,] 
#   nrow(slide.rdt)
  
  
  # summarise by psu
  compare = 
    slide.rdt %>% 
    group_by( region, psu ) %>%
    summarise( n = n(),
               n_slide = sum( slide %in% 0:1 ),
               n_rdt = sum( rdt %in% 0:1 ),
               slide_pos  = sum(slide %in% 1),
               rdt_pos = sum(rdt %in% 1),
               slidepos_rdtneg = sum( ifelse( slide %in% 1 & rdt %in% 0, 1, 0) ),
               slideneg_rdtpos = sum( ifelse( slide %in% 0 & rdt %in% 1, 1, 0) ),
               discordant = sum(slidepos_rdtneg , slideneg_rdtpos, na.rm = TRUE)
               ) %>%
    mutate( `%slide` = my.percent(slide_pos / n_slide),
            `%rdt` = my.percent( rdt_pos / n_rdt),
            `%slidepos_rdtneg` = my.percent( slidepos_rdtneg / n),
            `%slideneg_rdtpos` = my.percent( slideneg_rdtpos / n),
            `%discordant` = my.percent( discordant / n )
            ) 

  return(compare)
}

# rdt_slide_table(s)

# get all slide/rdts 
household_member_file = files %>% filter( file %in% 'Household Member Recode.rda') 

d = NA # initialize variable for data.frame of results
d.temp= NA
# nrow(household_member_file)
for ( i in 1:20 ){

    s = try(
      survey_data(
        country = household_member_file[i, "country"],
        survey_year = household_member_file[i, "survey_year"],
        design = TRUE)
    )
  
  if (sum(class(s) == "try-error")>0){ 
    print( "s try error") 
    next }
    
  result = try( rdt_slide_table(s), silent = TRUE)
  
  if ( sum(class(result) == "try-error")>0 ){ 
        print(paste( household_member_file[i, "country"], 
                     household_member_file[i, "survey_year"], ":", 
                     result[[1]])
              )
        d.temp = NA
        
    } else {
      print(paste( household_member_file[i, "country"],
                   household_member_file[i, "survey_year"]
#                    , 
#                    "has slide or rdt data")
            ))
      
      svy_mean_rdt = svymean(~hml32, s$design, na.rm = TRUE)
      
      d.temp = result %>%
        mutate( country = household_member_file[i, "country"],
                    survey_year = household_member_file[i, "survey_year"],
                mean_rdt = svy_mean_rdt[1],
                se_rdt = SE(svy_mean_rdt)[1]
    )
  }

  if (is.na(d)){
    d = d.temp
    print("d is NA")
  } else {
    if (!is.na(d.temp) ){
      d = rbind(d, d.temp)
      print( paste(nrow(d.temp), nrow(d)) )
    } 
  }
}

View(d)

save(d, file = "d.rda")

```

```{r, echo= FALSE, include= FALSE}

load("d.rda")
source("getSurveyValue.R")

country <- as.vector(unique(d$country))

# paste( 'There are ', length(unique( d$country)) ,'countries with slide and rdt data')
# paste( 'There are ', length(unique( c(d$country, d$survey_year)))  ,'surveys with slide and rdt data')

library(DT)  
require(dplyr)
require(tidyr)
library(ggvis)
library(ggplot2)
library(gridExtra)


```

## Average Test Positivity by Country

```{r, echo=FALSE, message= FALSE}

  d_country = 
  d %>% 
  group_by(country, survey_year) %>%
  summarise(
    n = sum(n),
    n_rdt = sum(n_rdt),
    n_slide = sum(n_slide),
    rdt = 100 * sum(rdt_pos) / n_rdt ,
    slide = 100* sum(slide_pos) / n_slide ) %>%
  as.data.frame() 

    # add id field
    d_country$id = 1:nrow(d_country)
#     
    survey_label_country <- function(x) {
      if(is.null(x)) return(NULL)
      paste( d_country[x$id, "country"], d_country[x$id, "survey_year"])
    }
#     
    reference_line = data.frame( x= c(0,85), y = c(0,85))
    
    d_country %>%
      ggvis(~slide, ~rdt) %>%
      layer_model_predictions( model = "lm", se = TRUE) %>%
      layer_points( fill = ~country, key := ~id) %>%
      add_tooltip( survey_label_country, "hover") %>%
      add_axis("x", title = "Slide % Positive") %>%
      add_axis("y", title = "RDT % Positive") %>%
      scale_numeric("x", domain = c(0, 85)) %>%
      scale_numeric("y", domain = c(0, 85)) %>%
      layer_paths( data = reference_line, x = ~x, y= ~y)
#
 
# regression
    linear = lm( rdt ~ slide, data = d_country)
    # summary(linear)
    `Linear Regression` = as.data.frame(cbind(round(linear$coefficients, 2),
                                              confint(linear))
                                        )
    names(`Linear Regression`) = c("Estimate", "LL", "UL")
    rownames(`Linear Regression`) = c("Intercept", "Slope")

    renderTable( `Linear Regression` )
```

## Surveys Available through DHS^[http://dhsprogram.com/data/available-datasets.cfm]

```{r, echo=FALSE, message= FALSE}

  observe({
    if (!is.null(input$myTable) && input$myTable != -1)
      updateTextInput(session, "myTextArea", value = retrieveAbstract(input$myTable))
  })
    
renderTable({ d_country  })
    
#    DT::datatable( d_country ,
# options = list(rowCallback = JS('
#             function(nRow, aData, iDisplayIndex, iDisplayIndexFull) {
#                                       // Bold and green cells for conditions
#                                       if (parseFloat(aData[3]) >= 20)
#                                       $("td:eq(3)", nRow).css("font-weight", "bold");
#                                       if (parseFloat(aData[3]) >= 10)
#                                       $("td:eq(3)", nRow).css("background-color", "#9BF59B");
#                                        }')
# ))

 
    

```

## country-region

```{r, echo=FALSE, message=FALSE}
    
  survey_label_cr <- function(x) {
      dd = d_cr()
      if(is.null(x)) return(NULL)
      paste( dd[x$id, "country"], 
             "region", dd[x$id, "region"], 
             dd[x$id, "survey_year"], 
             "n=", dd[x$id, "n"])
    }

  d_cr =  
    reactive({
      d %>%
      mutate(survey_name = paste(country, survey_year)) %>%
      group_by(country, region, survey_name) %>%
      summarise(
        n = sum(n),
        n_rdt = sum(n_rdt),
        n_slide = sum(n_slide),
        rdt = 100 * sum(rdt_pos) / n_rdt ,
        slide = 100* sum(slide_pos) / n_slide 
                ) %>%
      as.data.frame() %>%
      mutate( id = row_number()) 
  })    


    d_cr %>% 
      ggvis(~slide, ~rdt ) %>%
      layer_model_predictions( model = "lm", se = TRUE
                               ) %>%
      ungroup() %>%
      layer_points( fill = ~survey_name, key := ~id) %>%
      add_tooltip( survey_label_cr, "hover") %>%
      add_axis("x", title = "Slide % Positive") %>%
      add_axis("y", title = "RDT % Positive") %>%
      scale_numeric("x", domain = c(0, 85)) %>%
      scale_numeric("y", domain = c(0, 85)) %>%
      layer_paths( data = reference_line, x = ~x, y= ~y)
    
# Regression    
  table.cr = reactive({
      linear.cr =  lm( rdt ~ slide, data = d_cr() ) 
      t = as.data.frame(cbind(round(linear.cr$coefficients, 2),
                                              confint(linear.cr))
                                        )
      names(t) = c("Estimate", "LL", "UL")
      rownames(t) = c("Intercept", "Slope")
      return(t)
  })

  renderTable( table.cr() )
  
    
```

## Interactive Country Chart 

```{r , echo=FALSE, message= FALSE}
# By REGION
    
renderText( "For all countries there is some disagreement between the population rates of RDT and microcopy.  For some, there is substantial deviation. See: Cote d'Ivoire and Tanzania as examples")

inputPanel(

  selectInput("Country", label = "Country",
              choices = country, selected = "")
)
 
    survey_label <- function(x) {
      dd = d_r()
      if(is.null(x)) return(NULL)
      # paste(nrow(dd))
      paste( dd[x$id, "country"], 
             "region", dd[x$id, "region"], 
             dd[x$id, "survey_year"], 
             "n=", dd[x$id, "n"])
    }

  
  d_r =  reactive({
    d %>%
    # d[ country_selected, ] %>% 
    filter( (country %in% 
               ifelse( length(eval(input$Country))==0, 
                                         "Angola",
                                         eval(input$Country))) 
            ) %>%
    # filter( (country %in% country_selected) ) %>%
    group_by(country, region, survey_year) %>%
    summarise(
      n = sum(n),
      n_rdt = sum(n_rdt),
      n_slide = sum(n_slide),
      rdt = 100 * sum(rdt_pos) / n_rdt ,
      slide = 100* sum(slide_pos) / n_slide 
              ) %>%
    as.data.frame() %>%
    mutate( id = row_number(),
            survey_name = paste(country, survey_year)) 
  })    

    d_r %>% 
      group_by( survey_name) %>%
      ggvis(~slide, ~rdt ) %>%
      layer_model_predictions( model = "lm", se = TRUE
                               ) %>%
      ungroup() %>%
      layer_points( fill = ~survey_name, key := ~id) %>%
      add_tooltip( survey_label, "hover") %>%
      add_axis("x", title = "Slide % Positive") %>%
      add_axis("y", title = "RDT % Positive") %>%
      scale_numeric("x", domain = c(0, 85)) %>%
      scale_numeric("y", domain = c(0, 85)) %>%
      layer_paths( data = reference_line, x = ~x, y= ~y)

# Regression    
  table.r = reactive({
      linear.r =  lm( rdt ~ slide, data = d_r() ) 
      # t = as.data.frame(round(linear.r$coefficients, 2))
      t = as.data.frame(cbind(round(linear.r$coefficients, 2),
                                              confint(linear.r))
                                        )
      names(t) = c("Estimate", "LL", "UL")
      rownames(t) = c("Intercept", "Slope")
      return(t)
  })

  renderTable( table.r() )
  
      
```

# A Comparison of Test Standard Distribution 

## Cluster Standard Distribution within Region

Within each Region, the percent RDT and percent slide positive are calculated for each survey cluster.  Comparing the variance of these values may indicate the relative level of accuracy and repeatability of each method.


```{r, echo=FALSE, variance,  message= FALSE, eval=TRUE}
# 
 
  d_psu =  reactive({
    d %>%
    filter( (country %in% 
               ifelse( length(eval(input$Country))==0, 
                                         "Angola",
                                         eval(input$Country))) 
            ) %>%
    group_by(country, survey_year, region, psu ) %>%
    summarise(
      n = sum(n),
      n_rdt = sum(n_rdt),
      n_slide = sum(n_slide),
      rdt = 100 * sum(rdt_pos) / n_rdt ,
      slide = 100* sum(slide_pos) / n_slide 
              ) %>%
    as.data.frame() %>%
   gather(test, perc_pos, rdt, slide) %>%
    mutate( id = row_number(),
      survey_name = paste(country, survey_year)) %>%
   arrange(country, survey_year, region, psu, test)
    
  })



  # ggvis 
#     d_psu %>% 
#       ggvis(~factor(region), ~test) %>%
#       ungroup() %>%
#       layer_points( fill = ~test, key := ~id) %>%
#       add_tooltip( survey_label, "hover") %>%
#       add_axis("x", title = "Region") %>%
#       add_axis("y", title = "% Positive") %>%
#       # scale_numeric("x", domain = c(0, 85)) %>%
#       scale_numeric("y", domain = c(0, 85)) 
  
  
   
renderPlot({

     a = d_psu() %>% 
       mutate(region = factor(region)) %>%
      ggplot( aes(region, perc_pos)) +
      geom_boxplot(aes(fill = test)) +
       facet_grid(survey_year ~ .)
    
     b = d_psu() %>% 
       mutate(region = factor(region) )%>%
       group_by(survey_year, region, test) %>%
       summarise(
         std = sd(perc_pos)
       ) %>%
      ggplot( aes(region, std)) +
      geom_point(aes(color = test), size = 4, 
                 position = position_jitter(w = 0.1, h = 0.1)) +
      facet_grid(survey_year ~ .)

  grid.arrange(a,b, ncol=1)    
})   

# renderTable(d_psu())
```

## Pooled Standard Distribution

```{r, echo=FALSE, message = FALSE, warning = FALSE, pooled_variance}

  d_psus =  
    d %>%
    group_by(country, survey_year, region, psu ) %>%
    summarise(
      n = sum(n),
      n_rdt = sum(n_rdt),
      n_slide = sum(n_slide),
      rdt = 100 * sum(rdt_pos) / n_rdt ,
      slide = 100* sum(slide_pos) / n_slide 
              ) %>%
    as.data.frame() %>%
   gather(test, perc_pos, rdt, slide) %>%
    mutate( id = row_number(),
      survey_name = paste(country, survey_year)) %>%
   arrange(country, survey_year, region, psu, test)
    
# weighted std across regions 
  pooled_psu= 
    d_psus %>% 
       mutate(region = factor(region) ,
              test = factor(test)
              ) %>%
       group_by(country, survey_year, region, test) %>%
       summarise(
         n = sum(n),
         std = sd(perc_pos)
       ) %>%
      group_by(country, survey_year, test) %>%
    summarise(
      n = n(),
      pooled_sd = sqrt( sum(std^2 * (n - 1)) / (sum(n - 1)) )
    ) %>%
    mutate(
      id = paste(country, survey_year)
    )
    
# nrow(pooled_psu)
  
  ggplot(pooled_psu, aes(x = test, y= pooled_sd, color = test) ) +
           geom_point() + 
    geom_line( aes(group = id))
  
  pooled_psu %>% 
   spread(test, pooled_sd) %>%
  ggplot(aes(x = slide, y= rdt) ) + 
    geom_point() + 
    geom_smooth(method = "lm") +
    geom_abline(slope = 1 , intercept = 0)
    
# weighted std across all surveys 
  pooled_survey_sd= 
    pooled_psu %>% 
    group_by(test) %>%
    summarise(
      pooled_sd = sqrt( sum(pooled_sd^2 * (n - 1), na.rm = TRUE) / (sum(n - 1, na.rm = TRUE)) )
    ) 
    
  renderTable( pooled_survey_sd )
```


